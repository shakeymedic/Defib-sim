<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZOLL R Series Simulator V3 - WMEBEM | RCUK 2025 | Phase 1</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background: #2a2a2a;
            padding: 20px;
            min-height: 100vh;
        }

        /* Menu screens container */
        .menu-wrapper {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: calc(100vh - 40px);
        }

        /* Initial Menu Screen */
        .menu-screen {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            border-radius: 15px;
            padding: 60px;
            max-width: 800px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }

        .menu-logo {
            margin-bottom: 30px;
        }

        .menu-logo img {
            height: 80px;
            background: white;
            padding: 15px 25px;
            border-radius: 10px;
        }

        .menu-title {
            text-align: center;
            margin-bottom: 50px;
        }

        .menu-title h1 {
            color: #ecf0f1;
            font-size: 36px;
            margin-bottom: 15px;
        }

        .menu-title p {
            color: #bdc3c7;
            font-size: 18px;
        }

        .menu-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            width: 100%;
        }

        .menu-option {
            background: linear-gradient(180deg, #3498db 0%, #2874a6 100%);
            color: white;
            border: none;
            padding: 50px 40px;
            border-radius: 15px;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            text-align: center;
        }

        .menu-option:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0,0,0,0.4);
        }

        .menu-option.single-column {
            grid-column: 1 / -1;
        }

        .menu-option .subtitle {
            font-size: 14px;
            margin-top: 10px;
            opacity: 0.9;
            font-weight: normal;
        }

        /* Mode Selection Banner at Top */
        .mode-selection-banner {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .mode-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .mode-info img {
            height: 35px;
            background: white;
            padding: 5px 10px;
            border-radius: 6px;
        }

        .mode-info-text h3 {
            color: #ecf0f1;
            font-size: 16px;
            margin-bottom: 3px;
        }

        .mode-info-text p {
            color: #bdc3c7;
            font-size: 12px;
        }

        .mode-buttons {
            display: flex;
            gap: 15px;
        }

        .mode-toggle-btn {
            background: linear-gradient(180deg, #3498db 0%, #2874a6 100%);
            color: white;
            border: 3px solid #2874a6;
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .mode-toggle-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.4);
        }

        .mode-toggle-btn.active {
            background: linear-gradient(180deg, #27ae60 0%, #229954 100%);
            border-color: #229954;
            box-shadow: 0 0 20px rgba(39, 174, 96, 0.6);
        }

        /* Simulator Container */
        .simulator-container {
            max-width: 1600px;
            width: 100%;
            margin: 0 auto;
        }

        /* Back / Reset Buttons */
        .back-button {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin-bottom: 20px;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }

        .back-button:hover {
            background: #c0392b;
        }

        .reset-button {
            background: #3498db;
            margin-left: 10px;
        }

        .reset-button:hover {
            background: #2980b9;
        }

        /* Instructor Panel */
        .instructor-panel {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 20px;
            border: 3px solid #1a252f;
            transition: all 0.3s ease;
        }

        .instructor-panel.minimised {
            padding: 12px 18px;
        }

        .instructor-panel.minimised .control-grid {
            display: none !important;
        }

        .minimise-btn {
            background: #34495e;
            color: #ecf0f1;
            border: 2px solid #2c3e50;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .minimise-btn:hover {
            background: #3a4f5e;
        }

        .instructor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .instructor-logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .instructor-logo img {
            height: 40px;
            background: white;
            padding: 6px;
            border-radius: 8px;
        }

        .instructor-title h2 {
            color: #ecf0f1;
            font-size: 18px;
        }

        .instructor-title p {
            color: #bdc3c7;
            font-size: 12px;
            margin-top: 4px;
        }

        .control-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 15px;
            margin-top: 10px;
        }

        .control-section {
            background: #2c3e50;
            padding: 15px;
            border-radius: 8px;
        }

        .control-section h4 {
            color: #3498db;
            font-size: 13px;
            margin-bottom: 10px;
            text-transform: uppercase;
        }

        .control-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            padding: 8px;
            background: #34495e;
            border-radius: 6px;
        }

        .control-row label {
            color: #ecf0f1;
            font-size: 12px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .control-row input,
        .control-row select {
            width: 100px;
            padding: 6px;
            border-radius: 4px;
            border: 1px solid #2c3e50;
            background: #2c3e50;
            color: #00ff00;
            font-weight: bold;
        }

        .rhythm-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 6px;
        }

        .rhythm-btn {
            background: #34495e;
            color: #ecf0f1;
            border: 2px solid #2c3e50;
            padding: 8px;
            border-radius: 6px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .rhythm-btn.active {
            background: #2980b9;
            border-color: #1f5f8b;
        }

        /* ZOLL Device */
        .zoll-device {
            background: #c8d0d8;
            border: 20px solid #2b7bbf;
            border-radius: 25px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            position: relative;
            display: grid;
            grid-template-columns: 1.2fr 0.8fr;
            gap: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Left Side - Screen */
        .device-screen-section {
            background: #a8b0b8;
            padding: 25px;
            border-radius: 15px;
            box-shadow: inset 0 4px 10px rgba(0,0,0,0.2);
        }

        .screen {
            background: #000;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.8);
            position: relative;
        }

        .screen-header {
            display: flex;
            justify-content: space-between;
            padding: 8px;
            background: rgba(0,0,0,0.6);
            border-radius: 5px;
            margin-bottom: 10px;
        }

        .screen-info {
            color: #00ffff;
            font-size: 13px;
            font-family: 'Courier New', monospace;
            text-shadow: 0 0 5px rgba(0,255,255,0.5);
        }

        .screen-info.sync-indicator {
            color: #ffff00;
            font-weight: bold;
            animation: blink 1s infinite;
        }

        .ecg-canvas-container {
            background: #000;
            height: 300px;
            border-radius: 8px;
            position: relative;
            overflow: hidden;
            margin-bottom: 15px;
        }

        canvas {
            width: 100%;
            height: 100%;
        }

        .vitals-display {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            padding: 15px;
            background: rgba(0,0,0,0.6);
            border-radius: 8px;
        }

        .vital-item {
            text-align: center;
        }

        .vital-label {
            color: #888;
            font-size: 10px;
            margin-bottom: 5px;
        }

        .vital-value {
            color: #00ff00;
            font-size: 36px;
            font-weight: bold;
            font-family: 'Courier New', monospace;
            text-shadow: 0 0 10px rgba(0,255,0,0.6);
        }

        .vital-value.critical {
            color: #ff0000;
            animation: blink 1s infinite;
        }

        .vital-unit {
            color: #888;
            font-size: 11px;
            margin-top: 3px;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.3; }
        }

        .message-bar {
            background: rgba(0,0,0,0.8);
            color: #ffff00;
            padding: 12px;
            text-align: center;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            font-weight: bold;
            margin-top: 10px;
            text-shadow: 0 0 5px rgba(255,255,0,0.5);
        }

        .message-bar.ready {
            color: #00ff00;
            text-shadow: 0 0 5px rgba(0,255,0,0.5);
        }

        .message-bar.alert {
            color: #ff0000;
            animation: blink 1s infinite;
            text-shadow: 0 0 5px rgba(255,0,0,0.5);
        }

        .softkeys {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .softkey {
            flex: 1;
            background: #7a8288;
            color: #fff;
            border: 2px solid #6a7278;
            padding: 12px;
            border-radius: 6px;
            font-size: 11px;
            cursor: pointer;
            text-align: center;
            font-weight: bold;
        }

        .softkey:hover {
            background: #8a9298;
        }

        .softkey.active {
            background: #27ae60;
        }

        /* Right Side - Controls */
        .device-controls-section {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        /* Top buttons */
        .top-buttons {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 12px;
            align-items: start;
        }

        .btn-teal {
            background: #17a2b8;
            color: white;
            border: 3px solid #138496;
            padding: 15px 20px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .btn-sync {
            background: #f39c12;
            color: white;
            border: 3px solid #d68910;
            padding: 15px 20px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            transition: all 0.3s;
        }

        .btn-sync.active {
            background: #e67e22;
            box-shadow: 0 0 15px rgba(230, 126, 34, 0.7);
        }

        .btn-shock {
            background: linear-gradient(135deg, #ff6347 0%, #ff4520 100%);
            color: white;
            border: 5px solid #cc4f39;
            width: 120px;
            height: 120px;
            border-radius: 50%;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 6px 12px rgba(0,0,0,0.4);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        .btn-shock::before {
            content: '‚ö°';
            position: absolute;
            font-size: 80px;
            opacity: 0.15;
            color: #fff;
            z-index: 0;
        }

        .btn-shock span {
            position: relative;
            z-index: 1;
        }

        .btn-shock:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-shock .number {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 18px;
            color: #fff;
        }

        /* Side buttons */
        .side-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .side-btn {
            background: #7a8288;
            color: #fff;
            border: 3px solid #6a7278;
            padding: 12px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 3px 6px rgba(0,0,0,0.3);
        }

        .side-btn:hover {
            background: #8a9298;
        }

        /* Action buttons */
        .action-buttons-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .btn-analyze,
        .btn-charge {
            background: linear-gradient(180deg, #ff9933 0%, #ff7700 100%);
            color: #000;
            border: 4px solid #cc6600;
            padding: 16px;
            border-radius: 10px;
            font-size: 15px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .btn-number {
            background: #fff;
            color: #ff7700;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: bold;
        }

        .energy-selector {
            background: linear-gradient(180deg, #dc3545 0%, #c82333 100%);
            color: #fff;
            border: 4px solid #a71d2a;
            padding: 16px;
            border-radius: 10px;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .energy-display {
            font-size: 32px;
            font-weight: bold;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .energy-arrows {
            display: flex;
            gap: 15px;
        }

        .energy-arrow {
            background: #fff;
            color: #dc3545;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: none;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Mode Dial */
        .mode-dial-container {
            text-align: center;
            padding: 15px;
            background: #a8b0b8;
            border-radius: 12px;
        }

        .mode-dial {
            width: 150px;
            height: 150px;
            background: radial-gradient(circle, #2a2a2a 0%, #1a1a1a 100%);
            border: 6px solid #0a0a0a;
            border-radius: 50%;
            margin: 0 auto 15px;
            position: relative;
            cursor: pointer;
            box-shadow: 0 6px 12px rgba(0,0,0,0.5);
        }

        .mode-dial::before {
            content: '';
            position: absolute;
            width: 8px;
            height: 60px;
            background: #fff;
            top: 20px;
            left: 50%;
            transform: translateX(-50%) rotate(var(--dial-rotation, 0deg));
            transform-origin: center bottom;
            border-radius: 4px;
        }

        .mode-labels {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            font-size: 11px;
            font-weight: bold;
            color: #2a2a2a;
        }

        .mode-label {
            padding: 12px 16px;
            border-radius: 8px;
            cursor: pointer;
            background: #34495e;
            color: #ecf0f1;
            border: 3px solid #2c3e50;
            font-weight: bold;
            transition: all 0.3s;
            text-transform: uppercase;
            font-size: 13px;
        }

        .mode-label:hover {
            background: #3a4f5e;
            transform: translateY(-2px);
        }

        .mode-label.active {
            background: linear-gradient(180deg, #3498db 0%, #2874a6 100%);
            color: white;
            border-color: #1f5f8b;
            box-shadow: 0 0 15px rgba(52, 152, 219, 0.5);
        }

        /* Pacing Controls */
        .pacing-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .pacer-dial {
            background: #2a2a2a;
            border: 5px solid #0a0a0a;
            border-radius: 50%;
            width: 100px;
            height: 100px;
            margin: 0 auto;
            position: relative;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0,0,0,0.5);
        }

        .pacer-dial::before {
            content: '';
            position: absolute;
            width: 4px;
            height: 35px;
            background: #17a2b8;
            top: 15px;
            left: 50%;
            transform: translateX(-50%) rotate(var(--dial-rotation, 0deg));
            transform-origin: center 35px;
            border-radius: 2px;
            transition: transform 0.3s ease;
        }

        .pacer-label {
            text-align: center;
            color: #2a2a2a;
            font-size: 11px;
            font-weight: bold;
            margin-top: 8px;
        }

        .pacer-value {
            text-align: center;
            color: #17a2b8;
            font-size: 20px;
            font-weight: bold;
            margin-top: 4px;
        }

        .pacer-controls-btn {
            display: flex;
            gap: 5px;
            justify-content: center;
            margin-top: 8px;
        }

        .pacer-btn {
            background: #7a8288;
            color: #fff;
            border: 2px solid #6a7278;
            width: 35px;
            height: 35px;
            border-radius: 5px;
            font-size: 18px;
            cursor: pointer;
        }

        /* ZOLL Branding */
        .zoll-branding {
            background: linear-gradient(180deg, #e8eef3 0%, #d8dee3 100%);
            padding: 20px;
            border-radius: 0 0 15px 15px;
            margin: -30px -30px 0 -30px;
            text-align: center;
            box-shadow: 0 -4px 10px rgba(0,0,0,0.1);
        }

        .zoll-logo-text {
            font-size: 48px;
            font-weight: bold;
            color: #9a9a9a;
            letter-spacing: 8px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }

        @media (max-width: 1200px) {
            .zoll-device {
                grid-template-columns: 1fr;
            }
        }

        /* Print styles for certificate */
        @media print {
            body {
                background: white;
                padding: 0;
            }
            
            .menu-wrapper {
                min-height: 0;
            }
            
            .menu-screen {
                display: block !important;
                box-shadow: none;
                padding: 0;
                background: white;
            }
            
            .menu-option {
                display: none !important;
            }
            
            #certificateContent {
                box-shadow: none;
            }
        }

        /* ========================================
           PHASE 1 FEATURES CSS
           ======================================== */

        /* Achievement System */
        .achievement-container {
            position: fixed;
            top: 80px;
            right: 20px;
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            border-radius: 12px;
            padding: 15px;
            max-width: 280px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            z-index: 900;
            max-height: calc(100vh - 100px);
            overflow-y: auto;
        }

        .achievement-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            color: #ecf0f1;
            font-size: 16px;
            font-weight: bold;
        }

        .achievement-counter {
            background: linear-gradient(180deg, #f39c12 0%, #e67e22 100%);
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 13px;
            color: white;
        }

        .achievement-list {
            display: grid;
            gap: 8px;
        }

        .achievement-item {
            background: rgba(0,0,0,0.3);
            padding: 10px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
            border: 2px solid transparent;
            transition: all 0.3s;
        }

        .achievement-item.unlocked {
            border-color: #f39c12;
            background: linear-gradient(135deg, rgba(243, 156, 18, 0.2) 0%, rgba(230, 126, 34, 0.2) 100%);
        }

        .achievement-icon {
            font-size: 24px;
            filter: grayscale(1);
            opacity: 0.3;
        }

        .achievement-item.unlocked .achievement-icon {
            filter: grayscale(0);
            opacity: 1;
        }

        .achievement-info {
            flex: 1;
        }

        .achievement-name {
            font-size: 12px;
            font-weight: bold;
            color: #bdc3c7;
        }

        .achievement-item.unlocked .achievement-name {
            color: #f39c12;
        }

        .achievement-desc {
            font-size: 10px;
            color: #7f8c8d;
            margin-top: 2px;
        }

        /* Achievement Unlock Notification */
        .achievement-notification {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
            padding: 30px 40px;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.7);
            z-index: 10000;
            text-align: center;
            border: 4px solid #d68910;
            animation: achievement-popup 3s ease-out;
        }

        @keyframes achievement-popup {
            0% { transform: translate(-50%, -50%) scale(0); opacity: 0; }
            10% { transform: translate(-50%, -50%) scale(1.1); opacity: 1; }
            20% { transform: translate(-50%, -50%) scale(1); }
            80% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(0.8); opacity: 0; }
        }

        .achievement-notification .icon {
            font-size: 60px;
            margin-bottom: 15px;
        }

        .achievement-notification .title {
            font-size: 24px;
            font-weight: bold;
            color: white;
            margin-bottom: 10px;
        }

        .achievement-notification .description {
            font-size: 14px;
            color: rgba(255,255,255,0.9);
        }

        /* Hint System */
        .hint-panel {
            position: fixed;
            bottom: 20px;
            left: 20px;
            max-width: 400px;
            background: linear-gradient(135deg, #3498db 0%, #2874a6 100%);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            z-index: 950;
            border: 3px solid #2874a6;
            animation: hint-slide-up 0.3s ease-out;
            display: none;
        }

        @keyframes hint-slide-up {
            from {
                transform: translateY(100px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .hint-panel.urgency-medium {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
            border-color: #e67e22;
        }

        .hint-panel.urgency-high {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            border-color: #c0392b;
            animation: hint-pulse 2s infinite;
        }

        @keyframes hint-pulse {
            0%, 100% { box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
            50% { box-shadow: 0 10px 40px rgba(231, 76, 60, 0.6); }
        }

        .hint-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .hint-title {
            font-size: 16px;
            font-weight: bold;
            color: white;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .hint-close {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 16px;
            line-height: 1;
        }

        .hint-close:hover {
            background: rgba(255,255,255,0.3);
        }

        .hint-message {
            color: white;
            font-size: 14px;
            line-height: 1.6;
        }

        /* Quick Reference Button */
        .quick-ref-button {
            position: fixed;
            top: 80px;
            right: 320px;
            background: linear-gradient(180deg, #27ae60 0%, #229954 100%);
            color: white;
            border: 3px solid #229954;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 900;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .quick-ref-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.4);
        }

        /* Quick Reference Modal */
        .quick-reference-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.85);
            z-index: 10000;
            padding: 20px;
            overflow-y: auto;
        }

        .quick-reference-content {
            max-width: 1000px;
            margin: 0 auto;
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.7);
        }

        .quick-reference-header {
            background: #1a252f;
            padding: 20px 30px;
            border-radius: 15px 15px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .quick-reference-title {
            color: #ecf0f1;
            font-size: 24px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .quick-reference-close {
            background: #e74c3c;
            border: none;
            color: white;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            font-size: 24px;
            cursor: pointer;
            line-height: 1;
        }

        .quick-reference-close:hover {
            background: #c0392b;
        }

        .quick-reference-tabs {
            display: flex;
            background: #1a252f;
            padding: 0 30px;
            gap: 5px;
            border-bottom: 2px solid #34495e;
        }

        .quick-reference-tab {
            padding: 12px 20px;
            background: transparent;
            border: none;
            color: #95a5a6;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            border-radius: 8px 8px 0 0;
            transition: all 0.3s;
        }

        .quick-reference-tab:hover {
            background: rgba(52, 152, 219, 0.1);
            color: #3498db;
        }

        .quick-reference-tab.active {
            background: #2c3e50;
            color: #3498db;
        }

        .quick-reference-body {
            padding: 30px;
            color: #ecf0f1;
            max-height: calc(100vh - 200px);
            overflow-y: auto;
        }

        .quick-reference-tab-content {
            display: none;
        }

        .quick-reference-tab-content.active {
            display: block;
        }

        .qr-section {
            margin-bottom: 25px;
        }

        .qr-section-title {
            font-size: 18px;
            font-weight: bold;
            color: #3498db;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid #34495e;
        }

        .qr-algorithm-box {
            background: rgba(52, 152, 219, 0.1);
            border-left: 4px solid #3498db;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 5px;
        }

        .qr-algorithm-box h4 {
            color: #3498db;
            margin-bottom: 10px;
        }

        .qr-algorithm-box ul {
            margin-left: 20px;
            line-height: 1.8;
        }

        .qr-drug-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        .qr-drug-table th {
            background: #34495e;
            color: #3498db;
            padding: 10px;
            text-align: left;
            font-size: 13px;
        }

        .qr-drug-table td {
            padding: 10px;
            border-bottom: 1px solid #34495e;
            font-size: 13px;
        }

        .qr-drug-table tr:hover {
            background: rgba(52, 152, 219, 0.05);
        }

        .qr-energy-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        .qr-energy-table th {
            background: #e74c3c;
            color: white;
            padding: 10px;
            text-align: left;
            font-size: 13px;
        }

        .qr-energy-table td {
            padding: 10px;
            border-bottom: 1px solid #34495e;
            font-size: 13px;
        }

        .qr-rhythm-box {
            background: rgba(46, 204, 113, 0.1);
            border-left: 4px solid #27ae60;
            padding: 12px;
            margin-bottom: 12px;
            border-radius: 5px;
        }

        .qr-rhythm-box.shockable {
            background: rgba(231, 76, 60, 0.1);
            border-left-color: #e74c3c;
        }

        .qr-critical-point {
            background: rgba(243, 156, 18, 0.1);
            border-left: 4px solid #f39c12;
            padding: 12px;
            margin: 15px 0;
            border-radius: 5px;
            font-weight: bold;
        }

        /* Enhanced Artefact Controls */
        .artefact-controls-section {
            background: #1a252f;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .artefact-controls-title {
            color: #3498db;
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .artefact-control {
            background: #2c3e50;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 10px;
            border: 2px solid transparent;
            transition: all 0.3s;
        }

        .artefact-control.active {
            border-color: #e74c3c;
            background: rgba(231, 76, 60, 0.1);
        }

        .artefact-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .artefact-name {
            color: #ecf0f1;
            font-size: 12px;
            font-weight: bold;
        }

        .artefact-enable {
            background: #7f8c8d;
            color: white;
            border: none;
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
            cursor: pointer;
            min-width: 50px;
        }

        .artefact-enable.active {
            background: #e74c3c;
        }

        .severity-buttons {
            display: flex;
            gap: 5px;
        }

        .severity-btn {
            flex: 1;
            background: #34495e;
            color: #bdc3c7;
            border: 2px solid #2c3e50;
            padding: 6px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }

        .severity-btn:hover {
            background: #3d5a6b;
        }

        .severity-btn.active {
            background: #f39c12;
            color: white;
            border-color: #e67e22;
        }

    </style>
</head>
<body>
    <!-- Mode Selection Banner -->
    <div class="simulator-container" id="simulatorContainer" style="display: block;">
        <div class="mode-selection-banner">
            <div class="mode-info">
                <img src="https://iili.io/KGQOvkl.md.png" alt="WMEBEM Logo">
                <div class="mode-info-text">
                    <h3>ZOLL R Series Simulator</h3>
                    <p>WMEBEM Training | RCUK 2025</p>
                </div>
            </div>
            <div class="mode-buttons">
                <button class="mode-toggle-btn active" id="educationModeBtn" onclick="setSimulatorMode('education')">
                    üìö Education Mode
                </button>
                <button class="mode-toggle-btn" id="testingModeBtn" onclick="setSimulatorMode('testing')">
                    üìù Testing Mode
                </button>
            </div>
        </div>

        <!-- Scenario Selection (initially visible) -->
        <div id="scenarioSelection" style="background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%); border-radius: 10px; padding: 30px; margin-bottom: 20px;">
            <h2 style="color: #ecf0f1; text-align: center; margin-bottom: 25px; font-size: 24px;">Select a Clinical Scenario</h2>
            <div style="display: grid; gap: 15px; max-width: 1000px; margin: 0 auto;">
                <div style="background: #2c3e50; padding: 20px; border-radius: 10px; border: 2px solid #e74c3c;">
                    <h3 style="color: #e74c3c; margin-bottom: 15px; font-size: 18px;">Defibrillation (Cardiac Arrest)</h3>
                    <div style="display: grid; gap: 10px;">
                        <button class="menu-option" style="padding: 15px; text-align: left;" onclick="selectScenario('vf-arrest')">
                            <div style="font-size: 15px;">Ventricular Fibrillation</div>
                            <div class="subtitle">Coarse VF requiring immediate defibrillation</div>
                        </button>
                        <button class="menu-option" style="padding: 15px; text-align: left;" onclick="selectScenario('pulseless-vt')">
                            <div style="font-size: 15px;">Pulseless VT</div>
                            <div class="subtitle">Broad complex tachycardia with no pulse - treat as VF</div>
                        </button>
                    </div>
                </div>

                <div style="background: #2c3e50; padding: 20px; border-radius: 10px; border: 2px solid #f39c12;">
                    <h3 style="color: #f39c12; margin-bottom: 15px; font-size: 18px;">Cardioversion (With Pulse)</h3>
                    <div style="display: grid; gap: 10px;">
                        <button class="menu-option" style="padding: 15px; text-align: left;" onclick="selectScenario('unstable-vt')">
                            <div style="font-size: 15px;">VT with Pulse (Unstable)</div>
                            <div class="subtitle">Conscious patient with adverse features - needs synchronised shock</div>
                        </button>
                        <button class="menu-option" style="padding: 15px; text-align: left;" onclick="selectScenario('unstable-svt')">
                            <div style="font-size: 15px;">SVT with Adverse Features</div>
                            <div class="subtitle">Narrow complex tachycardia causing haemodynamic compromise</div>
                        </button>
                        <button class="menu-option" style="padding: 15px; text-align: left;" onclick="selectScenario('fast-af')">
                            <div style="font-size: 15px;">Fast AF with Adverse Features</div>
                            <div class="subtitle">Rapid atrial fibrillation with shock or heart failure</div>
                        </button>
                    </div>
                </div>

                <div style="background: #2c3e50; padding: 20px; border-radius: 10px; border: 2px solid #3498db;">
                    <h3 style="color: #3498db; margin-bottom: 15px; font-size: 18px;">Transcutaneous Pacing</h3>
                    <div style="display: grid; gap: 10px;">
                        <button class="menu-option" style="padding: 15px; text-align: left;" onclick="selectScenario('complete-hb')">
                            <div style="font-size: 15px;">Complete Heart Block</div>
                            <div class="subtitle">3rd degree AV block with adverse features requiring pacing</div>
                        </button>
                        <button class="menu-option" style="padding: 15px; text-align: left;" onclick="selectScenario('symptomatic-brady')">
                            <div style="font-size: 15px;">Symptomatic Bradycardia</div>
                            <div class="subtitle">Severe bradycardia unresponsive to atropine</div>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="menu-screen" id="summaryScreen" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.95); z-index: 1000; overflow-y: auto; padding: 40px 20px;">
            <div style="max-width: 1000px; margin: 0 auto;">
            <div class="menu-logo" style="text-align: center; margin-bottom: 30px;">
                <img src="https://iili.io/KGQOvkl.md.png" alt="WMEBEM Logo">
            </div>
            <div class="menu-title" style="text-align: center;">
                <h1>Scenario Complete</h1>
                <p>Defibrillator Performance Summary</p>
            </div>
            <div style="max-width: 1000px; width: 100%; display: grid; gap: 20px;">
                <div style="background: #2c3e50; padding: 25px; border-radius: 10px;">
                    <h3 style="color: #3498db; font-size: 20px; margin-bottom: 15px;">Scenario</h3>
                    <div id="summaryScenarioName" style="color: #ecf0f1; font-size: 18px; font-weight: bold; margin-bottom: 10px;"></div>
                    <div id="summaryScenarioDesc" style="color: #bdc3c7; font-size: 14px; line-height: 1.6;"></div>
                </div>

                <div style="background: #2c3e50; padding: 25px; border-radius: 10px;">
                    <h3 style="color: #3498db; font-size: 20px; margin-bottom: 15px;">Device Actions Performed</h3>
                    <div id="summaryActions" style="color: #ecf0f1; font-size: 14px; line-height: 1.8;"></div>
                </div>

                <div style="background: #2c3e50; padding: 25px; border-radius: 10px;">
                    <h3 style="color: #3498db; font-size: 20px; margin-bottom: 15px;">Performance Feedback</h3>
                    <div id="summaryFeedback" style="font-size: 14px; line-height: 1.8;"></div>
                </div>

                <div style="background: #2c3e50; padding: 25px; border-radius: 10px;">
                    <h3 style="color: #3498db; font-size: 20px; margin-bottom: 15px;">Patient Outcome</h3>
                    <div id="summaryOutcome" style="color: #ecf0f1; font-size: 16px; line-height: 1.6;"></div>
                </div>
            </div>
            <div style="display: flex; gap: 15px; margin-top: 20px; justify-content: center; flex-wrap: wrap;">
                <button class="menu-option" onclick="tryAgain()" style="padding: 20px 40px;">
                    üîÑ Try Again
                </button>
                <button class="menu-option" onclick="printCertificate()" style="padding: 20px 40px;">
                    üìÑ Print Certificate
                </button>
                <button class="menu-option" onclick="returnToScenarioSelect()" style="padding: 20px 40px;">
                    ‚Ü© Scenario Menu
                </button>
            </div>
            </div>
        </div>

        <div class="menu-screen" id="certificateScreen" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.95); z-index: 1000; overflow-y: auto; padding: 40px 20px;">
            <div id="certificateContent" style="background: white; padding: 60px; border-radius: 15px; color: #2c3e50; position: relative;">
                <div style="border: 8px solid #3498db; padding: 40px; border-radius: 10px;">
                    <div style="text-align: center; margin-bottom: 30px;">
                        <img src="https://iili.io/KGQOvkl.md.png" alt="WMEBEM Logo" style="height: 60px; margin-bottom: 20px;">
                        <h1 style="color: #2c3e50; font-size: 42px; margin-bottom: 10px;">Certificate of Completion</h1>
                        <div style="width: 100px; height: 3px; background: #3498db; margin: 20px auto;"></div>
                    </div>
                    
                    <div style="text-align: center; margin: 40px 0;">
                        <p style="font-size: 18px; color: #7f8c8d; margin-bottom: 20px;">This certifies that the learner has successfully completed</p>
                        <h2 id="certScenarioName" style="color: #2c3e50; font-size: 32px; margin: 20px 0; font-weight: bold;"></h2>
                        <p style="font-size: 16px; color: #7f8c8d;">ZOLL R Series Defibrillator Training</p>
                    </div>
                    
                    <div style="background: #ecf0f1; padding: 25px; border-radius: 8px; margin: 30px 0;">
                        <h3 style="color: #2c3e50; font-size: 20px; margin-bottom: 15px; text-align: center;">Performance Summary</h3>
                        <div id="certPerformance" style="font-size: 14px; line-height: 2;"></div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 40px;">
                        <div style="text-align: center;">
                            <div style="border-top: 2px solid #2c3e50; padding-top: 10px; margin: 0 20px;">
                                <p id="certDate" style="font-size: 14px; color: #7f8c8d;"></p>
                                <p style="font-size: 12px; color: #95a5a6; margin-top: 5px;">Date</p>
                            </div>
                        </div>
                        <div style="text-align: center;">
                            <div style="border-top: 2px solid #2c3e50; padding-top: 10px; margin: 0 20px;">
                                <p style="font-size: 14px; color: #7f8c8d;">WMEBEM Training</p>
                                <p style="font-size: 12px; color: #95a5a6; margin-top: 5px;">Authorised By</p>
                            </div>
                        </div>
                    </div>
                    
                    <div style="text-align: center; margin-top: 30px; padding-top: 20px; border-top: 1px solid #bdc3c7;">
                        <p style="font-size: 12px; color: #95a5a6;">RCUK 2025 Guidelines | Simulation Training Exercise</p>
                    </div>
                </div>
            </div>
            <div style="display: flex; gap: 15px; margin-top: 20px; justify-content: center;">
                <button class="menu-option" onclick="window.print()" style="padding: 15px 30px;">
                    üñ®Ô∏è Print
                </button>
                <button class="menu-option" onclick="backToSummary()" style="padding: 15px 30px;">
                    ‚Üê Back to Summary
                </button>
            </div>
        </div>
    </div>

    <div class="simulator-container" id="simulatorContainer" style="display: none;">
        <button class="back-button" onclick="endScenario()">
            ‚óÄ End Scenario
        </button>
        <button class="back-button reset-button" onclick="resetScenario()">
            üîÑ Reset Scenario
        </button>

        <div class="instructor-panel" id="instructorPanel" style="display: none;">
            <div class="instructor-header">
                <div class="instructor-logo">
                    <img src="https://iili.io/KGQOvkl.md.png" alt="WMEBEM Logo">
                    <div class="instructor-title">
                        <h2>Instructor Controls</h2>
                        <p id="instructorSubtitle">Scenario in Progress</p>
                    </div>
                </div>
                <button class="minimise-btn" id="minimiseBtn" onclick="toggleInstructorPanel()">‚ñ≤ Hide</button>
            </div>

            <div class="control-grid">
                <div class="control-section">
                    <h4>Quick Rhythm Change</h4>
                    <div class="rhythm-buttons">
                        <button class="rhythm-btn" onclick="quickSetRhythm('nsr')">NSR</button>
                        <button class="rhythm-btn" onclick="quickSetRhythm('vfib')">VF</button>
                        <button class="rhythm-btn" onclick="quickSetRhythm('vtach')">VT</button>
                        <button class="rhythm-btn" onclick="quickSetRhythm('svt')">SVT</button>
                        <button class="rhythm-btn" onclick="quickSetRhythm('afib')">AF</button>
                        <button class="rhythm-btn" onclick="quickSetRhythm('sinus_brady')">SB</button>
                        <button class="rhythm-btn" onclick="quickSetRhythm('sinus_tach')">ST</button>
                        <button class="rhythm-btn" onclick="quickSetRhythm('asystole')">ASY</button>
                        <button class="rhythm-btn" onclick="quickSetRhythm('chb')">CHB</button>
                        <button class="rhythm-btn" onclick="quickSetRhythm('paced')">PACED</button>
                        <button class="rhythm-btn" onclick="quickSetRhythm('idioventricular')">IVR</button>
                    </div>
                </div>

                <div class="control-section">
                    <h4>Status</h4>
                    <div style="color: #ecf0f1; font-size: 14px; line-height: 1.8;">
                        <div>Shocks: <strong id="shockCounter">0</strong></div>
                        <div>Sync mode: <strong id="syncStatus">OFF</strong></div>
                        <div>Pacing: <strong id="pacingStatus">OFF</strong></div>
                    </div>
                </div>

                <div class="control-section">
                    <h4>Artefact Overlays</h4>
                    <div class="control-row">
                        <label>
                            <input type="checkbox" onchange="toggleArtefact('movement', this.checked)">
                            Movement / patient motion
                        </label>
                    </div>
                    <div class="control-row">
                        <label>
                            <input type="checkbox" onchange="toggleArtefact('cpr', this.checked)">
                            CPR interference
                        </label>
                    </div>
                    <div class="control-row">
                        <label>
                            <input type="checkbox" onchange="toggleArtefact('leadoff', this.checked)">
                            Lead-off / poor contact
                        </label>
                    </div>
                </div>
            </div>
        </div>

        <div class="zoll-device" id="zollDevice" style="display: none;">
            <div class="device-screen-section">
                <div class="screen">
                    <div class="screen-header">
                        <div class="screen-info" id="leadInfo">LEAD: II</div>
                        <div class="screen-info" id="syncIndicator"></div>
                        <div class="screen-info" id="modeInfo">MODE: MONITOR</div>
                        <div class="screen-info" id="timeInfo">00:00:00</div>
                    </div>
                    
                    <div class="ecg-canvas-container">
                        <canvas id="ecgCanvas"></canvas>
                    </div>

                    <div class="vitals-display">
                        <div class="vital-item">
                            <div class="vital-label">HR</div>
                            <div class="vital-value" id="hrDisplay">75</div>
                            <div class="vital-unit">bpm</div>
                        </div>
                        <div class="vital-item">
                            <div class="vital-label">SpO‚ÇÇ</div>
                            <div class="vital-value" id="spo2Display">98</div>
                            <div class="vital-unit">%</div>
                        </div>
                        <div class="vital-item">
                            <div class="vital-label">ETCO‚ÇÇ</div>
                            <div class="vital-value" id="etco2Display">38</div>
                            <div class="vital-unit">mmHg</div>
                        </div>
                        <div class="vital-item">
                            <div class="vital-label">NIBP</div>
                            <div class="vital-value" id="bpDisplay" style="font-size: 24px;">120/80</div>
                            <div class="vital-unit">mmHg</div>
                        </div>
                    </div>

                    <div class="message-bar ready" id="messageBar">SIMULATOR READY</div>
                </div>

                <div class="softkeys">
                    <button class="softkey" onclick="checkPulse()">Check Pulse</button>
                    <button class="softkey">Param</button>
                    <button class="softkey">Marker</button>
                    <button class="softkey">Alarms</button>
                </div>
            </div>

            <div class="device-controls-section">
                <div class="top-buttons">
                    <button class="btn-sync" id="syncBtn" onclick="toggleSync()">SYNC</button>
                    <button class="btn-shock" id="shockBtn" onclick="deliverShock()" disabled>
                        SHOCK
                        <span class="number">3</span>
                    </button>
                </div>

                <div class="side-buttons">
                    <button class="side-btn">LEAD</button>
                    <button class="side-btn">SIZE</button>
                    <button class="side-btn">ALARM SUSPEND</button>
                    <button class="side-btn">RECORDER</button>
                </div>

                <div class="action-buttons-group">
                    <button class="btn-analyze" onclick="analyseRhythm()">
                        <span>ANALYSE</span>
                        <span class="btn-number">2</span>
                    </button>
                    <button class="btn-charge" id="chargeBtn" onclick="chargeDefib()">
                        <span>CHARGE</span>
                        <span class="btn-number">2</span>
                    </button>
                    <div class="energy-selector">
                        <div style="font-size: 11px;">ENERGY SELECT</div>
                        <div class="energy-display" id="energyDisplay">120</div>
                        <div style="font-size: 12px;">JOULES</div>
                        <div class="energy-arrows">
                            <button class="energy-arrow" onclick="adjustEnergy(-1)">‚ñº</button>
                            <button class="energy-arrow" onclick="adjustEnergy(1)">‚ñ≤</button>
                        </div>
                        <div class="btn-number" style="margin-top: -5px;">1</div>
                    </div>
                </div>

                <div class="mode-dial-container">
                    <div class="mode-dial" id="modeDial" style="--dial-rotation: 0deg;"></div>
                    <div class="mode-labels">
                        <div class="mode-label active" data-mode="monitor" onclick="setMode('monitor')">MONITOR</div>
                        <div class="mode-label" data-mode="defib" onclick="setMode('defib')">DEFIB</div>
                        <div class="mode-label" data-mode="pacer" onclick="setMode('pacer')">PACER</div>
                        <div class="mode-label" data-mode="off" onclick="setMode('off')">OFF</div>
                    </div>
                </div>

                <div class="pacing-controls">
                    <div>
                        <div class="pacer-label">OUTPUT</div>
                        <div class="pacer-dial" style="--dial-rotation: 0deg;"></div>
                        <div class="pacer-value" id="outputDisplay">0</div>
                        <div class="pacer-label">mA</div>
                        <div class="pacer-controls-btn">
                            <button class="pacer-btn" onclick="adjustPacer('output', -10)">-</button>
                            <button class="pacer-btn" onclick="adjustPacer('output', 10)">+</button>
                        </div>
                    </div>
                    <div>
                        <div class="pacer-label">RATE</div>
                        <div class="pacer-dial" style="--dial-rotation: 0deg;"></div>
                        <div class="pacer-value" id="rateDisplay">60</div>
                        <div class="pacer-label">ppm</div>
                        <div class="pacer-controls-btn">
                            <button class="pacer-btn" onclick="adjustPacer('rate', -10)">-</button>
                            <button class="pacer-btn" onclick="adjustPacer('rate', 10)">+</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="zoll-branding">
                <div class="zoll-logo-text">ZOLL</div>
            </div>
        </div>
    </div>

    <script>
        // Scenarios Configuration
        const scenarios = {
            'vf-arrest': {
                name: 'Ventricular Fibrillation',
                description: 'Patient in cardiac arrest. Monitor shows coarse VF. No pulse, not breathing. Requires immediate defibrillation.',
                category: 'defibrillation',
                initialRhythm: 'vfib',
                initialVitals: { hr: 0, spo2: 0, etco2: 0, bpSys: 0, bpDia: 0 },
                hasPulse: false,
                shockable: true,
                recommendedEnergy: 150,
                successEnergy: 150,
                successRhythm: 'nsr',
                successVitals: { hr: 82, spo2: 94, etco2: 35, bpSys: 110, bpDia: 70 },
                requiresSync: false,
                shockToConvert: 3
            },
            'pulseless-vt': {
                name: 'Pulseless Ventricular Tachycardia',
                description: 'Patient in cardiac arrest. Monitor shows broad complex tachycardia. CONFIRM NO PULSE - this is a shockable arrest.',
                category: 'defibrillation',
                initialRhythm: 'vtach',
                initialVitals: { hr: 0, spo2: 0, etco2: 0, bpSys: 0, bpDia: 0 },
                hasPulse: false,
                shockable: true,
                recommendedEnergy: 150,
                successEnergy: 150,
                successRhythm: 'nsr',
                successVitals: { hr: 78, spo2: 93, etco2: 34, bpSys: 108, bpDia: 68 },
                requiresSync: false,
                shockToConvert: 2
            },
            'unstable-vt': {
                name: 'VT with Pulse - Unstable',
                description: 'Patient conscious but severely unwell. Broad complex tachycardia at 180/min. Pulse present. BP 82/48. Requires SYNCHRONISED cardioversion.',
                category: 'cardioversion',
                initialRhythm: 'vtach',
                initialVitals: { hr: 180, spo2: 88, etco2: 28, bpSys: 82, bpDia: 48 },
                hasPulse: true,
                shockable: true,
                recommendedEnergy: 120,
                successEnergy: 120,
                successRhythm: 'nsr',
                successVitals: { hr: 76, spo2: 97, etco2: 36, bpSys: 118, bpDia: 74 },
                requiresSync: true,
                shockToConvert: 1
            },
            'unstable-svt': {
                name: 'SVT with Adverse Features',
                description: 'Patient with palpitations and chest pain. Narrow complex tachycardia at 190/min. BP 80/54. Requires SYNCHRONISED cardioversion.',
                category: 'cardioversion',
                initialRhythm: 'svt',
                initialVitals: { hr: 190, spo2: 90, etco2: 26, bpSys: 80, bpDia: 54 },
                hasPulse: true,
                shockable: true,
                recommendedEnergy: 100,
                successEnergy: 100,
                successRhythm: 'nsr',
                successVitals: { hr: 74, spo2: 98, etco2: 36, bpSys: 120, bpDia: 76 },
                requiresSync: true,
                shockToConvert: 1
            },
            'fast-af': {
                name: 'Fast AF with Adverse Features',
                description: 'Patient with fast irregular rhythm. Atrial fibrillation at 155/min. BP 82/48, pulmonary oedema developing. Requires SYNCHRONISED cardioversion.',
                category: 'cardioversion',
                initialRhythm: 'afib',
                initialVitals: { hr: 155, spo2: 88, etco2: 30, bpSys: 82, bpDia: 48 },
                hasPulse: true,
                shockable: true,
                recommendedEnergy: 120,
                successEnergy: 120,
                successRhythm: 'nsr',
                successVitals: { hr: 80, spo2: 96, etco2: 35, bpSys: 118, bpDia: 72 },
                requiresSync: true,
                shockToConvert: 1
            },
            'complete-hb': {
                name: 'Complete Heart Block',
                description: 'Patient syncopal and hypotensive. Complete dissociation between P waves and QRS. HR 32/min. BP 86/50. Requires transcutaneous pacing.',
                category: 'pacing',
                initialRhythm: 'chb',
                initialVitals: { hr: 32, spo2: 92, etco2: 30, bpSys: 86, bpDia: 50 },
                hasPulse: true,
                shockable: false,
                captureThreshold: 70,
                successRate: 70,
                successVitals: { hr: 70, spo2: 97, etco2: 36, bpSys: 115, bpDia: 72 },
                requiresPacing: true
            },
            'symptomatic-brady': {
                name: 'Symptomatic Bradycardia',
                description: 'Patient unwell with dizziness and hypotension. Bradycardia at 38/min. BP 84/52. Failed atropine. Requires pacing.',
                category: 'pacing',
                initialRhythm: 'brady',
                initialVitals: { hr: 38, spo2: 93, etco2: 31, bpSys: 84, bpDia: 52 },
                hasPulse: true,
                shockable: false,
                captureThreshold: 65,
                successRate: 70,
                successVitals: { hr: 70, spo2: 97, etco2: 35, bpSys: 112, bpDia: 70 },
                requiresPacing: true
            }
        };

        // State
        const state = {
            selectedMode: 'education',  // Default to education mode
            selectedScenario: null,
            scenarioActive: false,
            scenarioStartTime: null,
            deviceMode: 'monitor',
            rhythm: 'nsr',
            hr: 75,
            spo2: 98,
            etco2: 38,
            bpSys: 120,
            bpDia: 80,
            energy: 120,
            energyLevels: [50, 70, 85, 100, 120, 150, 170, 200],
            charged: false,
            syncMode: false,
            shockCount: 0,
            pacerOutput: 0,
            pacerRate: 60,
            pacingActive: false,
            actions: [],
            hasPulse: true,
            roscAchieved: false,
            noise: {
                movement: false,
                cpr: false,
                leadoff: false
            }
            
            // Phase 1: Artefact System
            artefacts: {
                mains: { enabled: false, severity: 0 },
                tremor: { enabled: false, severity: 0 },
                wander: { enabled: false, severity: 0 },
                leadoff: { enabled: false, severity: 0 },
                movement: { enabled: false, severity: 0 },
                cpr: { enabled: false, severity: 0 }
            },
            
            // Phase 1: Achievement System
            achievements: {
                first_shock: { unlocked: false, name: '‚ö° First Shock', desc: 'Deliver your first shock' },
                quick_response: { unlocked: false, name: '‚è±Ô∏è Quick Response', desc: 'Shock within 60 seconds' },
                sync_master: { unlocked: false, name: 'üéØ Sync Master', desc: 'Use SYNC correctly for cardioversion' },
                pacing_pro: { unlocked: false, name: 'üíì Pacing Pro', desc: 'Achieve pacing capture' },
                pulse_checker: { unlocked: false, name: 'ü´Ä Pulse Checker', desc: 'Check pulse 2+ times' },
                rhythm_reader: { unlocked: false, name: 'üìä Rhythm Reader', desc: 'Complete 5 different scenarios' },
                guideline_guru: { unlocked: false, name: '‚úÖ Guideline Guru', desc: 'Follow RCUK 2025 perfectly' },
                persistent: { unlocked: false, name: 'üîÑ Persistent', desc: 'Try same scenario 3 times' },
                all_scenarios: { unlocked: false, name: 'üèÜ All Scenarios', desc: 'Complete all 7 scenarios' },
                speed_demon: { unlocked: false, name: 'üöÄ Speed Demon', desc: 'Complete scenario <5 minutes' }
            },
            achievementsUnlocked: 0,
            scenariosCompleted: [],
            scenarioAttempts: {},
            
            // Phase 1: Hint System
            lastHintTime: 0,
            hintsShown: [],
            hintCheckInterval: null,
        };

        // Canvas
        let canvas, ctx, waveformX = 0, animationId;
        let lastTimestamp = 0;
        const ecgSpeed = 125; 

        function initCanvas() {
            canvas = document.getElementById('ecgCanvas');
            if (!canvas) return;
            
            ctx = canvas.getContext('2d');
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
            
            if (animationId) {
                cancelAnimationFrame(animationId);
            }
            lastTimestamp = 0;
            waveformX = 0;
            animationId = requestAnimationFrame(animate);
        }

        // HELPER: Normal sinus beat template
        function nsrTemplate(x, hr) {
            const baseline = canvas.height / 2;
            if (hr <= 0) return baseline;
            const cycle = (60 / hr) * ecgSpeed;
            const pos = (x % cycle);
            const s = pos / cycle;
            let y = baseline;

            // P wave: 0.00 - 0.10 (slightly longer for visibility)
            if (s < 0.10) {
                const p = s / 0.10;
                y -= Math.sin(p * Math.PI) * 12;
            }
            // PR segment: 0.10 - 0.20
            else if (s < 0.20) {
                y = baseline;
            }
            // QRS: sharp, tall, consistent: 0.20 - 0.32
            else if (s < 0.32) {
                const qrsPos = (s - 0.20) / 0.12;
                if (qrsPos < 0.15) { // Q wave
                    y += qrsPos / 0.15 * 12;
                } else if (qrsPos < 0.45) { // R wave upstroke
                    y += 12 - ((qrsPos - 0.15) / 0.30) * 92;
                } else if (qrsPos < 0.70) { // S wave downstroke
                    y -= 80 - ((qrsPos - 0.45) / 0.25) * 88;
                } else { // Return to baseline
                    y += (qrsPos - 0.70) / 0.30 * 8;
                }
            }
            // ST segment + T wave: 0.32 - 0.50
            else if (s < 0.50) {
                const t = (s - 0.32) / 0.18;
                y = baseline - Math.sin(t * Math.PI) * 22;
            }
            // Rest of cycle
            else {
                y = baseline;
            }

            return y;
        }

        // ECG Rhythms - IMPROVED VERSIONS
        const rhythms = {
            // Normal sinus rhythm
            nsr: (x, hr) => nsrTemplate(x, hr || 75),

            // Sinus bradycardia
            sinus_brady: (x, hr) => nsrTemplate(x, hr || 45),

            // Sinus tachycardia
            sinus_tach: (x, hr) => nsrTemplate(x, hr || 120),

            // IMPROVED: Ventricular tachycardia - VERY broad, monomorphic complexes
            vtach: (x, hr) => {
                const baseline = canvas.height / 2;
                const effectiveHr = hr && hr > 0 ? hr : 180;
                const cycle = (60 / effectiveHr) * ecgSpeed;
                const pos = (x % cycle);
                const s = pos / cycle;
                let y = baseline;

                // VERY BROAD QRS occupying 75-80% of cycle (VT duration typically 0.16-0.22s)
                // This is the key characteristic that differentiates VT from SVT
                if (s < 0.78) {
                    const p = s / 0.78;
                    if (p < 0.12) {
                        // Small initial deflection
                        y += p / 0.12 * 10;
                    } else if (p < 0.28) {
                        // SLOW upstroke to peak (broad!)
                        y += 10 - (p - 0.12) / 0.16 * 85;
                    } else if (p < 0.48) {
                        // Wide peak plateau (notched appearance)
                        const plateauPhase = (p - 0.28) / 0.20;
                        y -= 75 + Math.sin(plateauPhase * Math.PI * 2) * 8;
                    } else if (p < 0.72) {
                        // SLOW downstroke (broad!)
                        y -= 75 - (p - 0.48) / 0.24 * 95;
                    } else {
                        // Terminal return to baseline
                        y += (p - 0.72) / 0.28 * 20;
                    }
                } else {
                    // Very short isoelectric period between complexes
                    y = baseline;
                }
                return y;
            },

            // IMPROVED: Supraventricular tachycardia - narrow, regular, rapid
            svt: (x, hr) => {
                const baseline = canvas.height / 2;
                const effectiveHr = hr && hr > 0 ? hr : 190;
                const cycle = (60 / effectiveHr) * ecgSpeed;
                const pos = (x % cycle);
                const s = pos / cycle;
                let y = baseline;

                // Very narrow QRS (0.08-0.10s typical)
                if (s < 0.12) {
                    const q = s / 0.12;
                    if (q < 0.20) {
                        // Small Q
                        y += q / 0.20 * 10;
                    } else if (q < 0.55) {
                        // Sharp R wave
                        y += 10 - (q - 0.20) / 0.35 * 90;
                    } else if (q < 0.75) {
                        // S wave
                        y -= 80 - (q - 0.55) / 0.20 * 90;
                    } else {
                        // Return
                        y += (q - 0.75) / 0.25 * 10;
                    }
                }
                // ST and T wave compressed
                else if (s < 0.35) {
                    const t = (s - 0.12) / 0.23;
                    y = baseline - Math.sin(t * Math.PI) * 18;
                } else {
                    y = baseline;
                }
                return y;
            },

            // COMPLETELY REWORKED: Atrial fibrillation - irregularly irregular with fine f waves
            afib: (x, hr, tSeconds = 0) => {
                const baseline = canvas.height / 2;
                const baseHr = hr && hr > 0 ? hr : 140;

                // CRITICAL: True irregularity using multiple phase-shifted sine waves
                // This creates genuinely unpredictable RR intervals - the hallmark of AF
                const irregularity = 
                    0.40 * Math.sin(tSeconds * 1.7 + x * 0.0041) + 
                    0.32 * Math.sin(tSeconds * 2.3 + x * 0.0037) +
                    0.25 * Math.sin(tSeconds * 3.1 + x * 0.0029) +
                    0.18 * Math.sin(tSeconds * 1.1 + x * 0.0053);
                
                const effectiveHr = baseHr * (1 + irregularity);
                const cycle = (60 / effectiveHr) * ecgSpeed;
                const pos = (x % cycle);
                const s = pos / cycle;
                let y = baseline;

                // FINE fibrillatory waves (f waves) on baseline
                // These are the KEY diagnostic feature of AF
                // Frequency ~350-600/min, amplitude should be subtle (~0.5-1mm = 2.5-5 pixels)
                const fWaves = 
                    Math.sin((x * 0.58) + tSeconds * 7.8) * 3.0 +
                    Math.sin((x * 0.87) + tSeconds * 6.2) * 2.2 +
                    Math.sin((x * 1.21) + tSeconds * 8.5) * 1.8 +
                    Math.sin((x * 0.41) + tSeconds * 5.9) * 2.5 +
                    Math.sin((x * 1.53) + tSeconds * 7.1) * 1.5;

                // QRS - NARROW complexes (normal ventricular conduction)
                // NO P waves before them - this is AF!
                // Variable amplitude between beats
                if (s < 0.12) {
                    const qrsPos = s / 0.12;
                    // More pronounced beat-to-beat amplitude variation
                    const ampMod = 0.65 + 0.35 * Math.sin((tSeconds * 2.9) + (x * 0.0021));
                    
                    if (qrsPos < 0.18) {
                        // Small Q wave
                        y += ampMod * (qrsPos / 0.18 * 10);
                    } else if (qrsPos < 0.52) {
                        // Sharp R wave (narrow - normal conduction)
                        y += ampMod * (10 - (qrsPos - 0.18) / 0.34 * 85);
                    } else if (qrsPos < 0.72) {
                        // S wave
                        y -= ampMod * (75 - (qrsPos - 0.52) / 0.20 * 80);
                    } else {
                        // Return
                        y += ampMod * ((qrsPos - 0.72) / 0.28 * 5);
                    }
                } 
                // Very short ST segment and small T wave (compressed at fast rate)
                else if (s < 0.28) {
                    const t = (s - 0.12) / 0.16;
                    // Small T wave
                    y = baseline - Math.sin(t * Math.PI) * 8;
                }
                // Rest is isoelectric with continuous f waves
                else {
                    y = baseline;
                }

                // Add the continuous fine fibrillatory waves throughout
                // This is what makes it AF - the "bumpy" irregular baseline
                return y + fWaves;
            },

            // IMPROVED: Ventricular fibrillation - chaotic, coarse to fine
            vfib: (x, hr, tSeconds = 0) => {
                const baseline = canvas.height / 2;

                // Decay from coarse to fine over 2 minutes
                const timeFactor = Math.min(tSeconds / 120, 1);
                const coarseAmp = 50;
                const fineAmp = 15;
                const amplitude = coarseAmp * (1 - timeFactor) + fineAmp * timeFactor;

                // Multiple chaotic frequency components for realistic VF
                const y =
                    Math.sin((x * 0.22) + tSeconds * 4.2) * amplitude * 1.0 +
                    Math.sin((x * 0.58) + tSeconds * 5.1) * amplitude * 0.7 +
                    Math.sin((x * 0.83) + tSeconds * 3.7) * amplitude * 0.5 +
                    Math.sin((x * 0.37) + tSeconds * 6.3) * amplitude * 0.4 +
                    Math.sin((x * 1.12) + tSeconds * 4.9) * amplitude * 0.3;

                return baseline + y;
            },

            // Bradycardia - slow sinus
            brady: (x, hr) => nsrTemplate(x, hr || 38),

            // IMPROVED: Complete heart block - clear dissociation
            chb: (x, hr) => {
                const baseline = canvas.height / 2;

                // Atrial rate ~75, ventricular rate from hr or ~32
                const pRate = 75;
                const vRate = hr && hr > 0 ? hr : 32;

                const pCycle = (60 / pRate) * ecgSpeed;
                const qrsCycle = (60 / vRate) * ecgSpeed;

                let y = baseline;

                // Clear P waves
                const pPos = (x % pCycle) / pCycle;
                if (pPos < 0.10) {
                    y -= Math.sin((pPos / 0.10) * Math.PI) * 10;
                }

                // Wide, slow QRS complexes - escape rhythm
                const qPos = (x % qrsCycle) / qrsCycle;
                if (qPos < 0.40) {
                    const p = qPos / 0.40;
                    if (p < 0.15) {
                        // Initial deflection
                        y += p / 0.15 * 10;
                    } else if (p < 0.40) {
                        // Broad upstroke
                        y += 10 - (p - 0.15) / 0.25 * 75;
                    } else if (p < 0.70) {
                        // Wide peak
                        y -= 65 + Math.sin((p - 0.40) / 0.30 * Math.PI) * 5;
                    } else {
                        // Downstroke
                        y -= 65 - (p - 0.70) / 0.30 * 75;
                    }
                } else if (qPos < 0.60) {
                    // Broad T wave
                    const t = (qPos - 0.40) / 0.20;
                    y = baseline - Math.sin(t * Math.PI) * 15;
                }

                return y;
            },

            // Asystole - flatline
            asystole: () => canvas.height / 2,

            // Idioventricular rhythm - slow, wide
            idioventricular: (x, hr) => {
                const baseline = canvas.height / 2;
                const effectiveHr = hr && hr > 0 ? hr : 40;
                const cycle = (60 / effectiveHr) * ecgSpeed;
                const pos = (x % cycle);
                const s = pos / cycle;
                let y = baseline;

                if (s < 0.55) {
                    const p = s / 0.55;
                    if (p < 0.20) {
                        y -= p / 0.20 * 55;
                    } else if (p < 0.50) {
                        y -= 55 - (p - 0.20) / 0.30 * 65;
                    } else {
                        y += (p - 0.50) / 0.50 * 10;
                    }
                } else if (s < 0.75) {
                    const t = (s - 0.55) / 0.20;
                    y = baseline - Math.sin(t * Math.PI) * 18;
                } else {
                    y = baseline;
                }
                return y;
            },

            // Paced rhythm - sharp spike + wide QRS
            paced: (x, hr) => {
                const baseline = canvas.height / 2;
                const effectiveHr = hr && hr > 0 ? hr : 70;
                const cycle = (60 / effectiveHr) * ecgSpeed;
                const pos = (x % cycle);
                let y = baseline;

                // Very sharp pacing spike
                if (pos < 3) {
                    return baseline - 120;
                }

                const s = pos / cycle;

                // Wide paced QRS
                if (s < 0.28) {
                    const qrsPos = (s) / 0.28;
                    if (qrsPos < 0.30) {
                        y -= qrsPos / 0.30 * 75;
                    } else if (qrsPos < 0.60) {
                        y -= 75 - (qrsPos - 0.30) / 0.30 * 75;
                    } else {
                        y += (qrsPos - 0.60) / 0.40 * 30;
                    }
                } else if (s < 0.50) {
                    const t = (s - 0.28) / 0.22;
                    y = baseline - Math.sin(t * Math.PI) * 20;
                } else {
                    y = baseline;
                }

                return y;
            }
        };

        function getRhythmHR(rhythm) {
            const hrs = {
                nsr: 75,
                vfib: 0,
                vtach: 180,
                svt: 190,
                afib: 140,
                brady: 38,
                chb: 32,
                paced: 70,
                sinus_brady: 45,
                sinus_tach: 120,
                asystole: 0,
                idioventricular: 40
            };
            return hrs[rhythm] || 75;
        }

        // IMPROVED: Animation function with SYNC MARKERS
        function animate(timestamp) {
            if (!canvas || !ctx) return;
            
            if (lastTimestamp === 0) {
                lastTimestamp = timestamp;
            }
            const deltaTime = (timestamp - lastTimestamp) / 1000;
            lastTimestamp = timestamp;
            
            const pixelsToMove = ecgSpeed * deltaTime;

            const simTimeSeconds = state.scenarioStartTime
                ? (Date.now() - state.scenarioStartTime) / 1000
                : 0;
            
            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Grid - small squares
            ctx.strokeStyle = '#0a2a0a';
            ctx.lineWidth = 0.5;
            for (let i = 0; i < canvas.width; i += 5) {
                ctx.beginPath();
                ctx.moveTo(i, 0);
                ctx.lineTo(i, canvas.height);
                ctx.stroke();
            }
            for (let i = 0; i < canvas.height; i += 5) {
                ctx.beginPath();
                ctx.moveTo(0, i);
                ctx.lineTo(canvas.width, i);
                ctx.stroke();
            }
            
            // Grid - big squares
            ctx.strokeStyle = '#1a3a1a';
            ctx.lineWidth = 1;
            for (let i = 0; i < canvas.width; i += 25) {
                ctx.beginPath();
                ctx.moveTo(i, 0);
                ctx.lineTo(i, canvas.height);
                ctx.stroke();
            }
            for (let i = 0; i < canvas.height; i += 25) {
                ctx.beginPath();
                ctx.moveTo(0, i);
                ctx.lineTo(canvas.width, i);
                ctx.stroke();
            }
            
            // Draw rhythm
            const displayRhythm =
                (state.pacingActive && state.pacerOutput > 0) ? 'paced' : state.rhythm;
            const rhythmFunc = rhythms[displayRhythm];
            
            if (rhythmFunc) {
                const baseline = canvas.height / 2;
                const displayHR = (state.pacingActive && state.pacerOutput > 0)
                    ? state.pacerRate
                    : state.hr;

                // Store waveform data for sync marker detection
                const waveformData = [];
                const rWavePositions = [];

                // First pass: generate waveform and store data
                for (let x = 0; x < canvas.width; x++) {
                    let y = rhythmFunc(waveformX + x, displayHR, simTimeSeconds);

                    // Artefact overlays
                    if (state.noise.movement) {
                        y += Math.sin((waveformX + x) * 0.02 + simTimeSeconds * 3) * 6;
                    }
                    if (state.noise.cpr) {
                        const cprPeriod = ecgSpeed * 0.5;
                        const phase = (waveformX + x) % cprPeriod;
                        if (phase < 12) {
                            y -= 60 * (1 - phase / 12);
                        }
                    }
                    if (state.noise.leadoff) {
                        const pattern = Math.sin((waveformX + x) * 0.001 + simTimeSeconds);
                        if (pattern > 0.6) {
                            y = baseline;
                        }
                    }

                    y = applyArtefacts(y, waveformX + x, simTimeSeconds, baseline);
                    waveformData.push(y);
                }

                // Draw the ECG waveform
                ctx.strokeStyle = '#00ff00';
                ctx.lineWidth = 2.5;
                ctx.shadowColor = 'rgba(0, 255, 0, 0.5)';
                ctx.shadowBlur = 3;
                ctx.beginPath();
                for (let x = 0; x < canvas.width; x++) {
                    if (x === 0) ctx.moveTo(x, waveformData[x]);
                    else ctx.lineTo(x, waveformData[x]);
                }
                ctx.stroke();
                ctx.shadowBlur = 0;

                // SYNC MARKER DETECTION AND DRAWING
                if (state.syncMode && displayRhythm !== 'vfib' && displayRhythm !== 'asystole') {
                    // Detect R waves (peaks significantly above baseline)
                    for (let x = 10; x < canvas.width - 10; x++) {
                        const current = waveformData[x];
                        const prev = waveformData[x - 1];
                        const next = waveformData[x + 1];
                        const prev5 = waveformData[x - 5];
                        const next5 = waveformData[x + 5];
                        
                        // Detect significant peaks (R waves)
                        // Looking for point significantly below baseline (above on screen) and is local minimum
                        if (current < baseline - 35 && 
                            current <= prev && 
                            current <= next &&
                            current < prev5 &&
                            current < next5) {
                            
                            // Check spacing from last R wave to avoid double detection
                            const lastRWave = rWavePositions[rWavePositions.length - 1];
                            if (!lastRWave || x - lastRWave > 40) {
                                rWavePositions.push(x);
                            }
                        }
                    }

                    // Draw sync markers at R wave positions
                    ctx.fillStyle = '#ffff00';
                    ctx.strokeStyle = '#ffff00';
                    ctx.lineWidth = 2.5;
                    ctx.shadowColor = 'rgba(255, 255, 0, 0.7)';
                    ctx.shadowBlur = 4;
                    
                    rWavePositions.forEach(xPos => {
                        const yPos = waveformData[xPos];
                        
                        // Draw upward-pointing triangle marker
                        ctx.beginPath();
                        ctx.moveTo(xPos, yPos - 18);
                        ctx.lineTo(xPos - 8, yPos - 30);
                        ctx.lineTo(xPos + 8, yPos - 30);
                        ctx.closePath();
                        ctx.fill();
                        
                        // Draw vertical line from triangle to waveform
                        ctx.beginPath();
                        ctx.moveTo(xPos, yPos - 18);
                        ctx.lineTo(xPos, yPos + 5);
                        ctx.stroke();
                    });
                    
                    ctx.shadowBlur = 0;
                }
            }
            
            waveformX += pixelsToMove;
            animationId = requestAnimationFrame(animate);
        }


        // ============================================
        // ACHIEVEMENT SYSTEM
        // ============================================
        
        function initAchievements() {
            const container = document.getElementById('achievementContainer');
            const list = document.getElementById('achievementList');
            
            if (!container || !list) return;
            
            list.innerHTML = '';
            
            Object.keys(state.achievements).forEach(key => {
                const achievement = state.achievements[key];
                const item = document.createElement('div');
                item.className = 'achievement-item' + (achievement.unlocked ? ' unlocked' : '');
                item.id = `achievement-${key}`;
                
                const icon = achievement.name.split(' ')[0];
                const name = achievement.name.substring(achievement.name.indexOf(' ') + 1);
                
                item.innerHTML = `
                    <div class="achievement-icon">${icon}</div>
                    <div class="achievement-info">
                        <div class="achievement-name">${name}</div>
                        <div class="achievement-desc">${achievement.desc}</div>
                    </div>
                `;
                
                list.appendChild(item);
            });
            
            updateAchievementCounter();
            container.style.display = 'block';
        }
        
        function updateAchievementCounter() {
            const counter = document.getElementById('achievementCounter');
            if (!counter) return;
            
            const total = Object.keys(state.achievements).length;
            const unlocked = state.achievementsUnlocked;
            counter.textContent = `${unlocked}/${total}`;
        }
        
        function unlockAchievement(key) {
            if (!state.achievements[key] || state.achievements[key].unlocked) return;
            
            state.achievements[key].unlocked = true;
            state.achievementsUnlocked++;
            
            // Update display
            const item = document.getElementById(`achievement-${key}`);
            if (item) {
                item.classList.add('unlocked');
            }
            
            updateAchievementCounter();
            
            // Show notification
            showAchievementNotification(state.achievements[key]);
            
            // Play sound
            playSound('achievement');
        }
        
        function showAchievementNotification(achievement) {
            const icon = achievement.name.split(' ')[0];
            const name = achievement.name.substring(achievement.name.indexOf(' ') + 1);
            
            const notification = document.createElement('div');
            notification.className = 'achievement-notification';
            notification.innerHTML = `
                <div class="icon">${icon}</div>
                <div class="title">Achievement Unlocked!</div>
                <div class="description">${name}: ${achievement.desc}</div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }
        
        function checkAchievements() {
            // First Shock
            if (state.shockCount >= 1 && !state.achievements.first_shock.unlocked) {
                unlockAchievement('first_shock');
            }
            
            // Quick Response (shock within 60s)
            if (state.shockCount >= 1) {
                const firstShock = state.actions.find(a => a.action.includes('delivered'));
                if (firstShock && firstShock.time <= 60 && !state.achievements.quick_response.unlocked) {
                    unlockAchievement('quick_response');
                }
            }
            
            // Sync Master
            const scenario = scenarios[state.selectedScenario];
            if (scenario && scenario.hasPulse && state.syncMode && state.shockCount >= 1) {
                if (!state.achievements.sync_master.unlocked) {
                    unlockAchievement('sync_master');
                }
            }
            
            // Pacing Pro
            if (state.pacerOutput >= 80 && state.pacingActive) {
                if (!state.achievements.pacing_pro.unlocked) {
                    unlockAchievement('pacing_pro');
                }
            }
            
            // Pulse Checker
            const pulseChecks = state.actions.filter(a => a.action === 'Pulse check performed');
            if (pulseChecks.length >= 2 && !state.achievements.pulse_checker.unlocked) {
                unlockAchievement('pulse_checker');
            }
            
            // Rhythm Reader (5 scenarios)
            if (state.scenariosCompleted.length >= 5 && !state.achievements.rhythm_reader.unlocked) {
                unlockAchievement('rhythm_reader');
            }
            
            // All Scenarios (7 scenarios)
            if (state.scenariosCompleted.length >= 7 && !state.achievements.all_scenarios.unlocked) {
                unlockAchievement('all_scenarios');
            }
            
            // Persistent (same scenario 3 times)
            if (state.selectedScenario && state.scenarioAttempts[state.selectedScenario] >= 3) {
                if (!state.achievements.persistent.unlocked) {
                    unlockAchievement('persistent');
                }
            }
            
            // Speed Demon (<5 min)
            if (state.roscAchieved && state.scenarioStartTime) {
                const elapsed = (Date.now() - state.scenarioStartTime) / 1000;
                if (elapsed < 300 && !state.achievements.speed_demon.unlocked) {
                    unlockAchievement('speed_demon');
                }
            }
        }
        
        // ============================================
        // HINT SYSTEM
        // ============================================
        
        function showHint(message, urgency = 'low', title = 'üí° Hint') {
            const panel = document.getElementById('hintPanel');
            const titleEl = document.getElementById('hintTitle');
            const messageEl = document.getElementById('hintMessage');
            
            if (!panel || !titleEl || !messageEl) return;
            
            // Check if hint was shown recently (anti-spam)
            const now = Date.now();
            if (now - state.lastHintTime < 10000) return; // 10 second cooldown
            
            // Check if this specific hint was already shown
            if (state.hintsShown.includes(message)) return;
            
            state.lastHintTime = now;
            state.hintsShown.push(message);
            
            // Set urgency class
            panel.className = 'hint-panel';
            if (urgency === 'medium') {
                panel.classList.add('urgency-medium');
                titleEl.textContent = '‚ö†Ô∏è Important Hint';
            } else if (urgency === 'high') {
                panel.classList.add('urgency-high');
                titleEl.textContent = 'üö® Critical Hint';
            } else {
                titleEl.textContent = title;
            }
            
            messageEl.textContent = message;
            panel.style.display = 'block';
            
            // Auto-hide medium urgency hints after 15 seconds
            if (urgency === 'medium') {
                setTimeout(() => {
                    panel.style.display = 'none';
                }, 15000);
            }
            // High urgency hints stay until dismissed
        }
        
        function closeHint() {
            const panel = document.getElementById('hintPanel');
            if (panel) panel.style.display = 'none';
        }
        
        function checkForHints() {
            if (!state.scenarioActive || !state.selectedScenario) return;
            
            const scenario = scenarios[state.selectedScenario];
            if (!scenario) return;
            
            const elapsed = state.scenarioStartTime ? (Date.now() - state.scenarioStartTime) / 1000 : 0;
            
            // Hint 1: Cardiac arrest not recognized (high urgency)
            if (!scenario.hasPulse && state.shockCount === 0 && elapsed > 30) {
                showHint(
                    'Patient has NO pulse - this is cardiac arrest! Immediate defibrillation required for VF/VT.',
                    'high'
                );
            }
            
            // Hint 2: Wrong sync mode for arrest (high urgency)
            if (!scenario.hasPulse && state.syncMode && elapsed > 20) {
                showHint(
                    'In cardiac arrest (no pulse), turn OFF sync mode. Defibrillation should be unsynchronised.',
                    'high'
                );
            }
            
            // Hint 3: Sync not used for cardioversion (high urgency)
            if (scenario.hasPulse && !state.syncMode && state.charged && scenario.category === 'cardioversion') {
                showHint(
                    'Patient has a pulse - you should use SYNC mode for cardioversion to avoid inducing VF.',
                    'high'
                );
            }
            
            // Hint 4: Low pacing output (medium urgency)
            if (scenario.requiresPacing && state.pacingActive && state.pacerOutput < 70 && elapsed > 45) {
                showHint(
                    'Pacing output seems low. Try starting at ‚â•70mA and increase until you achieve capture.',
                    'medium'
                );
            }
            
            // Hint 5: Delayed first shock (medium urgency)
            if (!scenario.hasPulse && state.shockCount === 0 && elapsed > 90) {
                showHint(
                    'Time to first shock is important in cardiac arrest. RCUK guidelines recommend minimising delays.',
                    'medium'
                );
            }
            
            // Hint 6: No pulse check (medium urgency)
            const pulseChecks = state.actions.filter(a => a.action === 'Pulse check performed');
            if (pulseChecks.length === 0 && elapsed > 60) {
                showHint(
                    'Have you checked for a pulse? This determines whether to use defibrillation or cardioversion.',
                    'medium'
                );
            }
        }
        
        // ============================================
        // QUICK REFERENCE FUNCTIONS
        // ============================================
        
        function openQuickReference() {
            const modal = document.getElementById('quickReferenceModal');
            if (modal) {
                modal.style.display = 'block';
            }
        }
        
        function closeQuickReference() {
            const modal = document.getElementById('quickReferenceModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }
        
        function showQuickRefTab(tabName) {
            // Hide all tab contents
            const contents = document.querySelectorAll('.quick-reference-tab-content');
            contents.forEach(c => c.classList.remove('active'));
            
            // Remove active class from all tabs
            const tabs = document.querySelectorAll('.quick-reference-tab');
            tabs.forEach(t => t.classList.remove('active'));
            
            // Show selected tab content
            const content = document.getElementById(`qr-${tabName}`);
            if (content) content.classList.add('active');
            
            // Set active tab button
            const activeTab = Array.from(tabs).find(t => t.textContent.toLowerCase().includes(tabName.substring(0, 3)));
            if (activeTab) activeTab.classList.add('active');
        }
        
        // ============================================
        // ARTEFACT SYSTEM
        // ============================================
        
        function toggleArtefact(type) {
            if (!state.artefacts[type]) return;
            
            state.artefacts[type].enabled = !state.artefacts[type].enabled;
            
            // Update UI
            const control = document.getElementById(`artefact-${type}`);
            const button = control?.querySelector('.artefact-enable');
            
            if (state.artefacts[type].enabled) {
                control?.classList.add('active');
                if (button) button.textContent = 'ON';
                button?.classList.add('active');
                
                // Set to low severity if enabling
                if (state.artefacts[type].severity === 0) {
                    setArtefactSeverity(type, 1);
                }
            } else {
                control?.classList.remove('active');
                if (button) button.textContent = 'OFF';
                button?.classList.remove('active');
            }
        }
        
        function setArtefactSeverity(type, level) {
            if (!state.artefacts[type]) return;
            
            state.artefacts[type].severity = level;
            
            // Update UI
            const control = document.getElementById(`artefact-${type}`);
            const buttons = control?.querySelectorAll('.severity-btn');
            
            buttons?.forEach((btn, index) => {
                if (index === level) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
            
            // Enable artefact if setting severity > 0
            if (level > 0 && !state.artefacts[type].enabled) {
                toggleArtefact(type);
            }
        }
        
        function applyArtefacts(y, x, t, baseline) {
            let modifiedY = y;
            
            // Apply each enabled artefact
            if (state.artefacts.mains.enabled && state.artefacts.mains.severity > 0) {
                const amplitude = [0, 3, 6, 10][state.artefacts.mains.severity];
                modifiedY += Math.sin(x * 0.15 + t * 10) * amplitude;
            }
            
            if (state.artefacts.tremor.enabled && state.artefacts.tremor.severity > 0) {
                const amplitude = [0, 4, 8, 14][state.artefacts.tremor.severity];
                modifiedY += Math.sin(x * 0.3 + t * 8) * amplitude * 0.6;
                modifiedY += Math.random() * amplitude * 0.4;
            }
            
            if (state.artefacts.wander.enabled && state.artefacts.wander.severity > 0) {
                const amplitude = [0, 15, 30, 50][state.artefacts.wander.severity];
                modifiedY += Math.sin(x * 0.008 + t * 0.5) * amplitude;
                modifiedY += Math.sin(x * 0.015 + t * 0.3) * amplitude * 0.5;
            }
            
            if (state.artefacts.leadoff.enabled && state.artefacts.leadoff.severity > 0) {
                const probability = [0, 0.005, 0.015, 0.03][state.artefacts.leadoff.severity];
                if (Math.random() < probability) {
                    return baseline + (Math.random() - 0.5) * 200;
                }
            }
            
            if (state.artefacts.movement.enabled && state.artefacts.movement.severity > 0) {
                const amplitude = [0, 20, 40, 70][state.artefacts.movement.severity];
                modifiedY += Math.sin(x * 0.02 + t * 3) * amplitude;
                modifiedY += Math.sin(x * 0.05 + t * 4) * amplitude * 0.5;
                if (Math.random() < 0.01) {
                    modifiedY += (Math.random() - 0.5) * amplitude * 2;
                }
            }
            
            if (state.artefacts.cpr.enabled && state.artefacts.cpr.severity > 0) {
                const amplitude = [0, 25, 50, 80][state.artefacts.cpr.severity];
                const compressionRate = 100 / 60; // ~100 compressions per minute
                const period = ecgSpeed / compressionRate;
                const phase = (x % period) / period;
                
                if (phase < 0.3) {
                    modifiedY -= amplitude * (1 - phase / 0.3);
                }
            }
            
            return modifiedY;
        }
        
        function updateDisplays() {
            const scenario = scenarios[state.selectedScenario];
            let displayHR = state.hr;
            
            if (scenario && !scenario.hasPulse && !state.roscAchieved) {
                displayHR = 0;
            }
            
            if (state.pacingActive && state.pacerOutput > 0) {
                const captureThreshold = scenario?.captureThreshold || 70;
                if (state.pacerOutput >= captureThreshold) {
                    displayHR = state.pacerRate;
                }
            }
            
            document.getElementById('hrDisplay').textContent = displayHR;
            document.getElementById('spo2Display').textContent = state.spo2;
            document.getElementById('etco2Display').textContent = state.etco2;
            document.getElementById('bpDisplay').textContent = `${state.bpSys}/${state.bpDia}`;
            document.getElementById('energyDisplay').textContent = state.energy;
            document.getElementById('outputDisplay').textContent = state.pacerOutput;
            document.getElementById('rateDisplay').textContent = state.pacerRate;
            document.getElementById('modeInfo').textContent = `MODE: ${state.deviceMode.toUpperCase()}`;
            
            // Sync indicator
            const syncIndicator = document.getElementById('syncIndicator');
            if (state.syncMode) {
                syncIndicator.textContent = 'SYNC';
                syncIndicator.className = 'screen-info sync-indicator';
            } else {
                syncIndicator.textContent = '';
                syncIndicator.className = 'screen-info';
            }
            
            // Update vital signs styling
            const hrEl = document.getElementById('hrDisplay');
            hrEl.className = 'vital-value';
            if (displayHR === 0) {
                hrEl.classList.add('critical');
            }
            
            const spo2El = document.getElementById('spo2Display');
            spo2El.className = 'vital-value';
            if (state.spo2 === 0) {
                spo2El.classList.add('critical');
            }
            
            // Update instructor panel
            if (document.getElementById('shockCounter')) {
                document.getElementById('shockCounter').textContent = state.shockCount;
            }
            if (document.getElementById('syncStatus')) {
                document.getElementById('syncStatus').textContent = state.syncMode ? 'ON' : 'OFF';
            }
            if (document.getElementById('pacingStatus')) {
                document.getElementById('pacingStatus').textContent = state.pacingActive ? 'ACTIVE' : 'OFF';
            }
        }

        function setMessage(text, type = 'ready') {
            const msgEl = document.getElementById('messageBar');
            if (!msgEl) return;
            msgEl.textContent = text;
            msgEl.className = 'message-bar ' + type;
        }

        function logAction(action, details = '') {
            const timestamp = state.scenarioStartTime ? 
                Math.floor((Date.now() - state.scenarioStartTime) / 1000) : 0;
            state.actions.push({
                time: timestamp,
                action: action,
                details: details
            });
            console.log(`[${timestamp}s] ${action}${details ? ': ' + details : ''}`);
        }

        // Menu functions
        function setSimulatorMode(mode) {
            state.selectedMode = mode;
            
            // Update button states
            const educationBtn = document.getElementById('educationModeBtn');
            const testingBtn = document.getElementById('testingModeBtn');
            
            if (mode === 'education') {
                educationBtn.classList.add('active');
                testingBtn.classList.remove('active');
            } else {
                testingBtn.classList.add('active');
                educationBtn.classList.remove('active');
            }
            
            // Show/hide instructor panel accordingly if in active scenario
            if (state.scenarioActive) {
                const instructorPanel = document.getElementById('instructorPanel');
                if (mode === 'education') {
                    instructorPanel.style.display = 'block';
                } else {
                    instructorPanel.style.display = 'none';
                }
            }
        }

        function backToModeSelect() {
            // No longer needed - kept for compatibility
        }

        function selectScenario(scenarioId) {
            const scenario = scenarios[scenarioId];
            if (!scenario) return;
            
            state.selectedScenario = scenarioId;
            state.actions = [];
            state.shockCount = 0;
            state.syncMode = false;
            state.pacingActive = false;
            state.charged = false;
            state.roscAchieved = false;
            
            state.rhythm = scenario.initialRhythm;
            state.hr = scenario.initialVitals.hr;
            state.spo2 = scenario.initialVitals.spo2;
            state.etco2 = scenario.initialVitals.etco2;
            state.bpSys = scenario.initialVitals.bpSys;
            state.bpDia = scenario.initialVitals.bpDia;
            state.hasPulse = scenario.hasPulse;
            
            // Hide scenario selection
            document.getElementById('scenarioSelection').style.display = 'none';
            
            // Show device
            document.getElementById('zollDevice').style.display = 'grid';
            
            // Show instructor panel only in education mode
            if (state.selectedMode === 'education') {
                const panel = document.getElementById('instructorPanel');
                const btn = document.getElementById('minimiseBtn');
                panel.style.display = 'block';
                panel.classList.add('minimised');
                if (btn) btn.textContent = '‚ñº Show';
                document.getElementById('instructorSubtitle').textContent = scenario.name;
            } else {
                document.getElementById('instructorPanel').style.display = 'none';
            }

            initCanvas();
            updateDisplays();

            state.scenarioActive = false;
            let countdown = 3;
            setMessage(`SCENARIO STARTING IN ${countdown}...`, 'ready');

            const countdownInterval = setInterval(() => {
                countdown--;
                if (countdown > 0) {
                    setMessage(`SCENARIO STARTING IN ${countdown}...`, 'ready');
                } else {
                    clearInterval(countdownInterval);
                    state.scenarioStartTime = Date.now();
                    state.scenarioActive = true;

                
                // Initialize Phase 1 features
                initAchievements();
                document.getElementById('quickRefButton').style.display = 'block';
                state.lastHintTime = 0;
                state.hintsShown = [];
                
                // Start hint checking
                state.hintCheckInterval = setInterval(checkForHints, 5000);
                
                // Track scenario attempts
                if (!state.scenarioAttempts[scenarioId]) {
                    state.scenarioAttempts[scenarioId] = 0;
                }
                state.scenarioAttempts[scenarioId]++;

                    let msg = scenario.description.toUpperCase();
                    if (!scenario.hasPulse) {
                        setMessage(msg, 'alert');
                    } else {
                        setMessage(msg, 'ready');
                    }
                    logAction('Scenario started', scenario.name);
                }
            }, 1000);
        }

        function endScenario() {
            if (!state.selectedScenario) {
                returnToScenarioSelect();
                return;
            }
            if (!confirm('End the current scenario?')) return;
            
            state.scenarioActive = false;
            logAction('Scenario ended');
            
            if (animationId) {
                cancelAnimationFrame(animationId);
                animationId = null;
            }
            

            
            // Clean up Phase 1 features
            if (state.hintCheckInterval) {
                clearInterval(state.hintCheckInterval);
                state.hintCheckInterval = null;
            }
            closeHint();
            
            // Mark scenario as completed
            if (state.selectedScenario && !state.scenariosCompleted.includes(state.selectedScenario)) {
                state.scenariosCompleted.push(state.selectedScenario);
            }
            
            checkAchievements();
            showSummary();
        }

        function resetScenario() {
            if (!state.selectedScenario) return;
            if (!confirm('Reset this scenario?')) return;
            selectScenario(state.selectedScenario);
        }

        function showSummary() {
            const scenario = scenarios[state.selectedScenario];
            if (!scenario) {
                returnToScenarioSelect();
                return;
            }
            
            // Hide device
            document.getElementById('zollDevice').style.display = 'none';
            document.getElementById('instructorPanel').style.display = 'none';
            
            // Show summary screen
            document.getElementById('summaryScreen').style.display = 'block';
            
            document.getElementById('summaryScenarioName').textContent = scenario.name;
            document.getElementById('summaryScenarioDesc').textContent = scenario.description;
            
            let actionsHTML = '';
            if (state.actions.length > 0) {
                actionsHTML = '<div style="display: grid; gap: 8px;">';
                state.actions.forEach(action => {
                    const timestamp = action.time ? `${Math.floor(action.time / 60)}:${String(action.time % 60).padStart(2, '0')}` : '0:00';
                    actionsHTML += `<div style="padding: 10px; background: #34495e; border-radius: 5px;">
                        <strong style="color: #3498db;">${timestamp}</strong> - ${action.action}${action.details ? ': ' + action.details : ''}
                    </div>`;
                });
                actionsHTML += '</div>';
            } else {
                actionsHTML = '<div style="color: #e74c3c;">No actions recorded</div>';
            }
            document.getElementById('summaryActions').innerHTML = actionsHTML;
            
            const feedback = generateFeedback(scenario);
            document.getElementById('summaryFeedback').innerHTML = feedback;
            
            const outcome = generateOutcome(scenario);
            document.getElementById('summaryOutcome').innerHTML = outcome;
        }

        function generateFeedback(scenario) {
            let html = '';
            const goodPoints = [];
            const improvementPoints = [];
            
            const modeChanges = state.actions.filter(a => a.action === 'Mode changed');
            const shocks = state.actions.filter(a => a.action.includes('delivered'));
            const syncActivated = state.actions.find(a => a.action === 'Sync mode activated');
            const pacingActions = state.actions.filter(a => a.action.includes('Pacing'));
            const pulseChecks = state.actions.filter(a => a.action === 'Pulse check performed');
            
            if (pulseChecks.length > 0) {
                goodPoints.push(`‚úì Pulse checked ${pulseChecks.length} time(s)`);
                
                if (pulseChecks[0].time <= 30) {
                    goodPoints.push('‚úì Early pulse assessment performed');
                }
            } else {
                improvementPoints.push('‚ö† No pulse check documented - critical for choosing correct intervention');
            }
            
            if (scenario.category === 'defibrillation') {
                const defibMode = modeChanges.find(m => m.details === 'DEFIB');
                if (defibMode) {
                    goodPoints.push('‚úì Defibrillator mode selected correctly');
                } else {
                    improvementPoints.push('‚úó Should switch to DEFIB mode for cardiac arrest');
                }
                
                if (syncActivated) {
                    improvementPoints.push('‚úó Sync mode should NOT be used for cardiac arrest (no pulse)');
                } else {
                    goodPoints.push('‚úì Correctly used unsynchronised shocks (no sync)');
                }
                
                if (shocks.length > 0) {
                    goodPoints.push(`‚úì ${shocks.length} shock(s) delivered`);
                    
                    const firstShock = shocks[0];
                    if (firstShock.details.includes(`${scenario.recommendedEnergy}J`) || 
                        firstShock.details.includes('150J') || 
                        firstShock.details.includes('200J')) {
                        goodPoints.push('‚úì Appropriate energy level selected');
                    } else {
                        improvementPoints.push(`‚ö† Recommended energy: ${scenario.recommendedEnergy}J or higher`);
                    }
                    
                    const timeToShock = firstShock.time;
                    if (timeToShock <= 60) {
                        goodPoints.push(`‚úì Rapid defibrillation (${timeToShock}s) - excellent`);
                    } else if (timeToShock <= 180) {
                        goodPoints.push(`‚úì Timely defibrillation (${timeToShock}s)`);
                    } else {
                        improvementPoints.push(`‚ö† Delay to first shock: ${timeToShock}s (aim for <60s in witnessed arrest)`);
                    }
                } else {
                    improvementPoints.push('‚úó No shocks delivered - shockable rhythm requires defibrillation');
                }
                
            } else if (scenario.category === 'cardioversion') {
                if (syncActivated) {
                    goodPoints.push('‚úì Sync mode activated correctly');
                } else {
                    improvementPoints.push('‚úó CRITICAL: Must use SYNC mode for cardioversion (patient has pulse)');
                }
                
                const defibMode = modeChanges.find(m => m.details === 'DEFIB');
                if (defibMode) {
                    goodPoints.push('‚úì Defibrillator mode selected');
                }
                
                if (shocks.length > 0) {
                    goodPoints.push('‚úì Cardioversion attempted');
                    
                    const firstShock = shocks[0];
                    const energyUsed = parseInt(firstShock.details.match(/(\d+)J/)?.[1] || '0');
                    if (Math.abs(energyUsed - scenario.recommendedEnergy) <= 30) {
                        goodPoints.push(`‚úì Appropriate energy used (${energyUsed}J)`);
                    } else {
                        improvementPoints.push(`‚ö† Recommended energy: ${scenario.recommendedEnergy}J for this rhythm`);
                    }
                    
                    const timeToShock = firstShock.time;
                    if (timeToShock <= 60) {
                        goodPoints.push(`‚úì Rapid cardioversion (${timeToShock}s)`);
                    } else {
                        improvementPoints.push(`‚ö† Time to cardioversion: ${timeToShock}s (aim for <60s when unstable)`);
                    }
                } else {
                    improvementPoints.push('‚úó No cardioversion attempted - patient has adverse features');
                }
                
            } else if (scenario.category === 'pacing') {
                const pacerMode = modeChanges.find(m => m.details === 'PACER');
                if (pacerMode) {
                    goodPoints.push('‚úì Pacing mode selected');
                } else {
                    improvementPoints.push('‚úó Should switch to PACER mode');
                }
                
                const outputAdjusted = pacingActions.find(a => a.action.includes('output'));
                if (outputAdjusted) {
                    goodPoints.push('‚úì Pacing output adjusted');
                    
                    const captureAchieved = pacingActions.find(a => a.action.includes('capture'));
                    if (captureAchieved) {
                        goodPoints.push('‚úì Electrical and mechanical capture achieved');
                    } else {
                        improvementPoints.push('‚ö† Increase output until capture achieved (check for palpable pulse)');
                    }
                }
                
                const rateAdjusted = pacingActions.find(a => a.action.includes('rate'));
                if (rateAdjusted) {
                    goodPoints.push('‚úì Pacing rate set appropriately');
                }
            }
            
            if (goodPoints.length > 0) {
                html += '<div style="background: rgba(39, 174, 96, 0.1); border-left: 4px solid #27ae60; padding: 15px; margin: 10px 0; border-radius: 5px;">';
                html += '<strong style="color: #27ae60;">Good Practice:</strong><ul style="margin: 10px 0; padding-left: 20px; color: #ecf0f1;">';
                goodPoints.forEach(p => html += `<li style="margin: 5px 0;">${p}</li>`);
                html += '</ul></div>';
            }
            
            if (improvementPoints.length > 0) {
                html += '<div style="background: rgba(231, 76, 60, 0.1); border-left: 4px solid #e74c3c; padding: 15px; margin: 10px 0; border-radius: 5px;">';
                html += '<strong style="color: #e74c3c;">Areas for Improvement:</strong><ul style="margin: 10px 0; padding-left: 20px; color: #ecf0f1;">';
                improvementPoints.forEach(i => html += `<li style="margin: 5px 0;">${i}</li>`);
                html += '</ul></div>';
            }
            
            if (html === '') {
                html = '<div style="color: #f39c12;">No device actions performed</div>';
            }
            
            return html;
        }

        function generateOutcome(scenario) {
            let html = '';
            
            if (scenario.category === 'defibrillation' || scenario.category === 'cardioversion') {
                const converted = state.rhythm === 'nsr' || state.hr < 100 || state.roscAchieved;
                if (converted) {
                    html = `<div style="color: #27ae60; font-size: 18px; font-weight: bold;">‚úì RHYTHM CONVERTED</div>
                        <div style="color: #ecf0f1; margin-top: 10px;">Patient now in sinus rhythm. Vital signs improving.</div>`;
                } else {
                    html = `<div style="color: #f39c12; font-size: 18px; font-weight: bold;">‚ö† Rhythm not converted</div>
                        <div style="color: #ecf0f1; margin-top: 10px;">Patient remains in abnormal rhythm. Continue management.</div>`;
                }
            } else if (scenario.category === 'pacing') {
                const captureAchieved = state.actions.find(a => a.action.includes('capture'));
                if (captureAchieved) {
                    html = `<div style="color: #27ae60; font-size: 18px; font-weight: bold;">‚úì PACING SUCCESSFUL</div>
                        <div style="color: #ecf0f1; margin-top: 10px;">Electrical and mechanical capture achieved. Patient stabilised.</div>`;
                } else {
                    html = `<div style="color: #f39c12; font-size: 18px; font-weight: bold;">‚ö† Pacing not successful</div>
                        <div style="color: #ecf0f1; margin-top: 10px;">Capture not yet achieved. Continue to increase output.</div>`;
                }
            }
            
            return html;
        }

        function returnToMenu() {
            returnToScenarioSelect();
        }

        function returnToScenarioSelect() {
            // Hide all overlays
            document.getElementById('summaryScreen').style.display = 'none';
            document.getElementById('certificateScreen').style.display = 'none';
            document.getElementById('zollDevice').style.display = 'none';
            document.getElementById('instructorPanel').style.display = 'none';
            
            // Show scenario selection
            document.getElementById('scenarioSelection').style.display = 'block';
            
            if (animationId) {
                cancelAnimationFrame(animationId);
                animationId = null;
            }
            
            state.scenarioActive = false;
            state.syncMode = false;
            state.pacingActive = false;
            state.charged = false;
            state.shockCount = 0;
            state.selectedScenario = null;
            state.actions = [];
            state.roscAchieved = false;
            
            updateDisplays();
        }

        function tryAgain() {
            const scenarioId = state.selectedScenario;
            if (!scenarioId) {
                returnToScenarioSelect();
                return;
            }
            
            // Hide summary
            document.getElementById('summaryScreen').style.display = 'none';
            
            // Restart scenario
            selectScenario(scenarioId);
        }

        // Device controls
        function setMode(mode) {
            state.deviceMode = mode;
            const labels = document.querySelectorAll('.mode-label');
            labels.forEach(label => {
                if (label.dataset.mode === mode) {
                    label.classList.add('active');
                } else {
                    label.classList.remove('active');
                }
            });
            
            const rotations = { monitor: 0, defib: 90, pacer: 180, off: 270 };
            document.getElementById('modeDial').style.setProperty('--dial-rotation', `${rotations[mode]}deg`);
            
            logAction('Mode changed', mode.toUpperCase());
            
            if (mode === 'pacer') {
                state.pacingActive = true;
            } else {
                state.pacingActive = false;
            }
            
            updateDisplays();
        }

        function toggleSync() {
            state.syncMode = !state.syncMode;
            const btn = document.getElementById('syncBtn');
            if (state.syncMode) {
                btn.classList.add('active');
                setMessage('SYNC MODE ON - SYNCHRONISED CARDIOVERSION', 'ready');
                logAction('Sync mode activated');
            } else {
                btn.classList.remove('active');
                setMessage('SYNC MODE OFF', 'ready');
                logAction('Sync mode deactivated');
            }
            updateDisplays();
        }

        function adjustEnergy(dir) {
            const idx = state.energyLevels.indexOf(state.energy);
            if (dir > 0 && idx < state.energyLevels.length - 1) {
                state.energy = state.energyLevels[idx + 1];
            } else if (dir < 0 && idx > 0) {
                state.energy = state.energyLevels[idx - 1];
            }
            state.charged = false;
            document.getElementById('shockBtn').disabled = true;
            logAction('Energy adjusted', `${state.energy}J`);
            updateDisplays();
        }

        function chargeDefib() {
            if (!state.scenarioActive) return;
            if (state.deviceMode !== 'defib') {
                setMessage('SWITCH TO DEFIB MODE TO CHARGE', '');
                return;
            }
            
            setMessage('CHARGING...', '');
            logAction('Charge initiated', `${state.energy}J`);
            playSound('charging');
            
            setTimeout(() => {
                state.charged = true;
                document.getElementById('shockBtn').disabled = false;
                setMessage(`${state.energy}J READY - ${state.syncMode ? 'SYNC' : 'UNSYNC'}`, 'alert');
                logAction('Charged', `${state.energy}J ready`);
                playSound('charged');
            }, 2000);
        }

        function deliverShock() {
            if (!state.scenarioActive) return;
            if (!state.charged) return;
            
            const scenario = scenarios[state.selectedScenario];
            state.shockCount++;
            const shockEnergy = state.energy;
            const shockType = state.syncMode ? 'synchronised' : 'unsynchronised';
            state.charged = false;
            document.getElementById('shockBtn').disabled = true;
            
            playSound('shock');
            checkAchievements();
            
            logAction(`Shock ${state.shockCount} delivered`, `${shockEnergy}J ${shockType}`);
            
            if (canvas) {
                canvas.style.background = '#fff';
                setTimeout(() => canvas.style.background = '#000', 100);
            }
            
            setMessage(`SHOCK ${state.shockCount} DELIVERED - ${shockEnergy}J`, 'alert');
            
            setTimeout(() => {
                let shouldConvert = false;
                
                if (scenario.category === 'defibrillation') {
                    if (state.shockCount >= scenario.shockToConvert && 
                        shockEnergy >= scenario.successEnergy) {
                        shouldConvert = true;
                    }
                } else if (scenario.category === 'cardioversion') {
                    if (state.syncMode && shockEnergy >= scenario.successEnergy - 30) {
                        shouldConvert = true;
                    }
                }
                
                if (shouldConvert) {
                    state.rhythm = scenario.successRhythm;
                    state.hr = scenario.successVitals.hr;
                    state.spo2 = scenario.successVitals.spo2;
                    state.etco2 = scenario.successVitals.etco2;
                    state.bpSys = scenario.successVitals.bpSys;
                    state.bpDia = scenario.successVitals.bpDia;
                    state.hasPulse = true;
                    state.roscAchieved = true;
                    
                    if (scenario.category === 'defibrillation') {
                        setMessage('RHYTHM CONVERTED - CHECK PULSE', 'ready');
                        logAction('ROSC achieved', 'Return of spontaneous circulation');
                    } else {
                        setMessage('RHYTHM CONVERTED TO SINUS', 'ready');
                        logAction('Cardioversion successful', 'Converted to sinus rhythm');
                    }
                    
                    updateDisplays();
                } else {
                    setMessage('CHECK RHYTHM', 'ready');
                }
            }, 2000);
        }

        function analyseRhythm() {
            if (!state.scenarioActive) return;
            setMessage('ANALYSING...', '');
            logAction('Rhythm analysed');
            
            setTimeout(() => {
                if (state.rhythm === 'vfib' || state.rhythm === 'vtach') {
                    setMessage('SHOCKABLE RHYTHM DETECTED', 'alert');
                    logAction('Analysis result', 'Shockable rhythm');
                } else {
                    setMessage('ORGANISED RHYTHM', 'ready');
                    logAction('Analysis result', 'Non-shockable rhythm');
                }
            }, 2500);
        }

        function adjustPacer(param, change) {
            const scenario = scenarios[state.selectedScenario];
            
            if (param === 'output') {
                state.pacerOutput = Math.max(0, Math.min(140, state.pacerOutput + change));
                logAction('Pacing output adjusted', `${state.pacerOutput}mA`);
                
                const rotation = (state.pacerOutput / 140) * 270;
                const dial = document.querySelector('.pacing-controls > div:first-child .pacer-dial');
                if (dial) dial.style.setProperty('--dial-rotation', `${rotation}deg`);
                
                if (scenario && scenario.requiresPacing && 
                    state.pacerOutput >= scenario.captureThreshold &&
                    state.deviceMode === 'pacer') {
                    
                    state.hr = scenario.successVitals.hr;
                    state.spo2 = scenario.successVitals.spo2;
                    state.etco2 = scenario.successVitals.etco2;
                    state.bpSys = scenario.successVitals.bpSys;
                    state.bpDia = scenario.successVitals.bpDia;
                    state.pacingActive = true;
                    
                    setMessage(`CAPTURE ACHIEVED AT ${state.pacerOutput}mA`, 'ready');
                    logAction('Pacing capture achieved', `Electrical and mechanical capture at ${state.pacerOutput}mA`);
                }
                
            } else if (param === 'rate') {
                state.pacerRate = Math.max(30, Math.min(180, state.pacerRate + change));
                logAction('Pacing rate adjusted', `${state.pacerRate}ppm`);
                
                const rotation = ((state.pacerRate - 30) / 150) * 270;
                const dial = document.querySelector('.pacing-controls > div:last-child .pacer-dial');
                if (dial) dial.style.setProperty('--dial-rotation', `${rotation}deg`);
            }
            
            updateDisplays();
        }

        function quickSetRhythm(rhythm) {
            state.rhythm = rhythm;
            state.hr = getRhythmHR(rhythm);
            state.roscAchieved = false;
            updateDisplays();
        }

        function toggleInstructorPanel() {
            const panel = document.getElementById('instructorPanel');
            if (!panel) return;
            const btn = document.getElementById('minimiseBtn');
            
            panel.classList.toggle('minimised');
            if (panel.classList.contains('minimised')) {
                btn.textContent = '‚ñº Show';
            } else {
                btn.textContent = '‚ñ≤ Hide';
            }
        }

        function toggleArtefact(type, isOn) {
            if (!state.noise.hasOwnProperty(type)) return;
            state.noise[type] = isOn;
        }

        function checkPulse() {
            const scenario = scenarios[state.selectedScenario];
            if (!scenario) {
                setMessage('CHECK PULSE - SIMULATOR NOT IN SCENARIO MODE', '');
                return;
            }
            
            setMessage('CHECKING FOR PULSE...', '');
            logAction('Pulse check performed');
            
            setTimeout(() => {
                if (scenario.hasPulse || state.roscAchieved) {
                    setMessage('PULSE PRESENT - CAROTID PULSE PALPABLE', 'ready');
                    logAction('Pulse check result', 'Pulse present');
                } else {
                    setMessage('NO PULSE DETECTED - CARDIAC ARREST CONFIRMED', 'alert');
                    logAction('Pulse check result', 'No pulse - cardiac arrest');
                }
            }, 1500);
        }

        function tryAgain() {
            const scenarioId = state.selectedScenario;
            if (!scenarioId) {
                returnToMenu();
                return;
            }
            
            document.getElementById('summaryScreen').style.display = 'none';
            selectScenario(scenarioId);
        }

        function printCertificate() {
            const scenario = scenarios[state.selectedScenario];
            if (!scenario) return;
            
            document.getElementById('summaryScreen').style.display = 'none';
            document.getElementById('certificateScreen').style.display = 'flex';
            
            document.getElementById('certScenarioName').textContent = scenario.name;
            
            const now = new Date();
            document.getElementById('certDate').textContent = now.toLocaleDateString('en-GB', {
                day: 'numeric',
                month: 'long',
                year: 'numeric'
            });
            
            let perfHTML = '<div style="display: grid; gap: 10px;">';
            
            const shocks = state.actions.filter(a => a.action.includes('delivered'));
            const syncUsed = state.actions.find(a => a.action === 'Sync mode activated');
            const pulseChecks = state.actions.filter(a => a.action === 'Pulse check performed');
            const pacingActions = state.actions.filter(a => a.action.includes('Pacing'));
            
            if (shocks.length > 0) {
                perfHTML += `<div><strong>Shocks Delivered:</strong> ${shocks.length}</div>`;
            }
            
            if (scenario.requiresSync) {
                perfHTML += `<div><strong>Sync Mode:</strong> ${syncUsed ? '‚úì Used correctly' : '‚úó Not used'}</div>`;
            }
            
            if (pulseChecks.length > 0) {
                perfHTML += `<div><strong>Pulse Checks:</strong> ${pulseChecks.length} performed</div>`;
            }
            
            if (scenario.category === 'pacing') {
                const captureAchieved = pacingActions.find(a => a.action.includes('capture'));
                perfHTML += `<div><strong>Pacing:</strong> ${captureAchieved ? '‚úì Capture achieved' : 'Attempted'}</div>`;
            }
            
            const converted = state.rhythm === 'nsr' || state.hr < 100 || state.roscAchieved;
            if (scenario.category === 'defibrillation' || scenario.category === 'cardioversion') {
                perfHTML += `<div><strong>Outcome:</strong> ${converted ? '‚úì Rhythm converted' : 'Rhythm not converted'}</div>`;
            }
            
            perfHTML += `<div><strong>Total Actions:</strong> ${state.actions.length}</div>`;
            
            let firstIntervention = null;
            if (shocks.length > 0) {
                firstIntervention = shocks[0];
            } else if (pacingActions.length > 0) {
                firstIntervention = pacingActions[0];
            }
            
            if (firstIntervention) {
                const timeToIntervention = firstIntervention.time;
                const minutes = Math.floor(timeToIntervention / 60);
                const seconds = timeToIntervention % 60;
                perfHTML += `<div><strong>Time to First Intervention:</strong> ${minutes}:${String(seconds).padStart(2, '0')}</div>`;
            }
            
            perfHTML += '</div>';
            
            document.getElementById('certPerformance').innerHTML = perfHTML;
        }

        function backToSummary() {
            document.getElementById('certificateScreen').style.display = 'none';
            document.getElementById('summaryScreen').style.display = 'flex';
        }

        // Audio
        function playSound(type) {
            const AudioCtx = window.AudioContext || window.webkitAudioContext;
            if (!AudioCtx) return;
            const audioContext = new AudioCtx();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            switch(type) {
                case 'charging':
                    oscillator.frequency.setValueAtTime(400, audioContext.currentTime);
                    oscillator.frequency.linearRampToValueAtTime(800, audioContext.currentTime + 2);
                    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 2);
                    break;
                    
                case 'charged':
                    oscillator.frequency.setValueAtTime(1000, audioContext.currentTime);
                    gainNode.gain.setValueAtTime(0.4, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.5);
                    break;
                    
                
                case 'achievement':
                    oscillator.frequency.setValueAtTime(600, audioContext.currentTime);
                    oscillator.frequency.linearRampToValueAtTime(800, audioContext.currentTime + 0.1);
                    oscillator.frequency.linearRampToValueAtTime(1000, audioContext.currentTime + 0.2);
                    gainNode.gain.setValueAtTime(0.4, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.5);
                    break;
                    
                case 'shock':
                    oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                    gainNode.gain.setValueAtTime(0.5, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.3);
                    break;
            }
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (!state.scenarioActive) return;
            const key = e.key.toLowerCase();

            if (key === 'c') {
                e.preventDefault();
                chargeDefib();
            } else if (key === 's') {
                e.preventDefault();
                deliverShock();
            } else if (key === 'p') {
                e.preventDefault();
                checkPulse();
            } else if (key === 'm') {
                e.preventDefault();
                cycleMode();
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                adjustEnergy(1);
            } else if (e.key === 'ArrowDown') {
                e.preventDefault();
                adjustEnergy(-1);
            }
        });

        function cycleMode() {
            const order = ['monitor', 'defib', 'pacer', 'off'];
            let idx = order.indexOf(state.deviceMode);
            if (idx === -1) idx = 0;
            const next = order[(idx + 1) % order.length];
            setMode(next);
        }

        // Clock
        setInterval(() => {
            const now = new Date();
            const timeEl = document.getElementById('timeInfo');
            if (timeEl) {
                timeEl.textContent = now.toTimeString().split(' ')[0];
            }
        }, 1000);
    </script>

    <!-- Quick Reference Modal -->
    <div class="quick-reference-modal" id="quickReferenceModal">
        <div class="quick-reference-content">
            <div class="quick-reference-header">
                <div class="quick-reference-title">üìñ Quick Reference Guide</div>
                <button class="quick-reference-close" onclick="closeQuickReference()">√ó</button>
            </div>
            <div class="quick-reference-tabs">
                <button class="quick-reference-tab active" onclick="showQuickRefTab('algorithms')">Algorithms</button>
                <button class="quick-reference-tab" onclick="showQuickRefTab('drugs')">Drug Doses</button>
                <button class="quick-reference-tab" onclick="showQuickRefTab('ecg')">ECG Guide</button>
                <button class="quick-reference-tab" onclick="showQuickRefTab('energy')">Energy Levels</button>
                <button class="quick-reference-tab" onclick="showQuickRefTab('pacing')">Pacing</button>
            </div>
            <div class="quick-reference-body">
                <!-- ALGORITHMS TAB -->
                <div id="qr-algorithms" class="quick-reference-tab-content active">
                    <div class="qr-section">
                        <div class="qr-section-title">Cardiac Arrest - Shockable Rhythms (VF/VT)</div>
                        <div class="qr-algorithm-box">
                            <h4>Initial Management</h4>
                            <ul>
                                <li><strong>Confirm cardiac arrest:</strong> Unresponsive, not breathing normally, no pulse</li>
                                <li><strong>Start CPR</strong> immediately (30:2 if no airway, continuous once intubated)</li>
                                <li><strong>Attach defibrillator/monitor</strong> as soon as available</li>
                                <li><strong>Identify shockable rhythm:</strong> VF or pulseless VT</li>
                            </ul>
                        </div>
                        
                        <div class="qr-algorithm-box">
                            <h4>Defibrillation Sequence</h4>
                            <ul>
                                <li><strong>1st Shock:</strong> 150-200J (biphasic), resume CPR immediately for 2 minutes</li>
                                <li><strong>After 3rd shock:</strong> Give Adrenaline 1mg IV + Amiodarone 300mg IV</li>
                                <li><strong>After 5th shock:</strong> Give Amiodarone 150mg IV (if not already given)</li>
                                <li><strong>Continue:</strong> Shock ‚Üí 2 min CPR ‚Üí Rhythm check cycle</li>
                                <li><strong>Adrenaline:</strong> 1mg IV every 3-5 minutes (alternate loops)</li>
                            </ul>
                        </div>
                        
                        <div class="qr-algorithm-box">
                            <h4>4Hs and 4Ts - Reversible Causes</h4>
                            <ul>
                                <li><strong>Hypoxia:</strong> Check ventilation, oxygen</li>
                                <li><strong>Hypovolaemia:</strong> Fluid resuscitation</li>
                                <li><strong>Hypo/hyperkalaemia:</strong> Check blood gas</li>
                                <li><strong>Hypothermia:</strong> Core temperature</li>
                                <li><strong>Thrombosis (coronary/pulmonary):</strong> Consider thrombolysis</li>
                                <li><strong>Tension pneumothorax:</strong> Decompress</li>
                                <li><strong>Tamponade (cardiac):</strong> Pericardiocentesis</li>
                                <li><strong>Toxins:</strong> Consider antidotes</li>
                            </ul>
                        </div>
                    </div>

                    <div class="qr-section">
                        <div class="qr-section-title">Tachycardia with Adverse Features</div>
                        <div class="qr-algorithm-box">
                            <h4>Adverse Features (any one requires immediate cardioversion)</h4>
                            <ul>
                                <li><strong>Shock:</strong> Hypotension (systolic BP <90mmHg), pallor, sweating, confusion</li>
                                <li><strong>Syncope:</strong> Loss of consciousness due to reduced cardiac output</li>
                                <li><strong>Myocardial ischaemia:</strong> Chest pain, ECG changes</li>
                                <li><strong>Heart failure:</strong> Pulmonary oedema, raised JVP</li>
                            </ul>
                        </div>
                        
                        <div class="qr-algorithm-box">
                            <h4>Synchronised Cardioversion</h4>
                            <ul>
                                <li><strong>Broad complex (VT):</strong> 120-150J</li>
                                <li><strong>Narrow complex (AF, Flutter, SVT):</strong> 70-120J</li>
                                <li><strong>Sedation required</strong> if conscious (unless immediately life-threatening)</li>
                                <li><strong>SYNC mode ON</strong> - synchronises with R wave</li>
                                <li><strong>If fails:</strong> Give amiodarone 300mg IV over 10-20 min, repeat cardioversion</li>
                            </ul>
                        </div>
                    </div>

                    <div class="qr-section">
                        <div class="qr-section-title">Bradycardia</div>
                        <div class="qr-algorithm-box">
                            <h4>Adverse Features</h4>
                            <ul>
                                <li><strong>Shock:</strong> Hypotension, pallor, sweating, confusion</li>
                                <li><strong>Syncope:</strong> Loss of consciousness</li>
                                <li><strong>Myocardial ischaemia:</strong> Chest pain</li>
                                <li><strong>Heart failure:</strong> Pulmonary oedema</li>
                            </ul>
                        </div>
                        
                        <div class="qr-algorithm-box">
                            <h4>Treatment Sequence</h4>
                            <ul>
                                <li><strong>Atropine:</strong> 500mcg IV, repeat up to maximum 3mg</li>
                                <li><strong>If atropine ineffective:</strong> Consider transcutaneous pacing</li>
                                <li><strong>Alternative drugs:</strong> Isoprenaline, adrenaline, dopamine infusions</li>
                                <li><strong>Seek expert help</strong> for transvenous pacing if temporary pacing required</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- DRUGS TAB -->
                <div id="qr-drugs" class="quick-reference-tab-content">
                    <div class="qr-section">
                        <div class="qr-section-title">Emergency Drug Doses (Adult)</div>
                        <table class="qr-drug-table">
                            <thead>
                                <tr>
                                    <th>Drug</th>
                                    <th>Indication</th>
                                    <th>Dose</th>
                                    <th>Route</th>
                                    <th>Timing/Notes</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><strong>Adrenaline</strong></td>
                                    <td>Cardiac arrest</td>
                                    <td>1mg (1:10,000)</td>
                                    <td>IV/IO</td>
                                    <td>After 3rd shock, then every 3-5 min</td>
                                </tr>
                                <tr>
                                    <td><strong>Amiodarone</strong></td>
                                    <td>VF/VT arrest</td>
                                    <td>300mg</td>
                                    <td>IV/IO</td>
                                    <td>After 3rd shock</td>
                                </tr>
                                <tr>
                                    <td><strong>Amiodarone</strong></td>
                                    <td>VF/VT arrest</td>
                                    <td>150mg</td>
                                    <td>IV/IO</td>
                                    <td>After 5th shock (if VF/VT persists)</td>
                                </tr>
                                <tr>
                                    <td><strong>Atropine</strong></td>
                                    <td>Bradycardia</td>
                                    <td>500mcg</td>
                                    <td>IV</td>
                                    <td>Repeat up to 3mg total</td>
                                </tr>
                                <tr>
                                    <td><strong>Adenosine</strong></td>
                                    <td>SVT</td>
                                    <td>6mg ‚Üí 12mg ‚Üí 12mg</td>
                                    <td>IV rapid</td>
                                    <td>Followed by 20ml flush, incremental doses</td>
                                </tr>
                                <tr>
                                    <td><strong>Magnesium sulphate</strong></td>
                                    <td>Torsades de pointes</td>
                                    <td>2g (8mmol)</td>
                                    <td>IV</td>
                                    <td>Over 1-2 minutes</td>
                                </tr>
                                <tr>
                                    <td><strong>Calcium chloride</strong></td>
                                    <td>Hyperkalaemia, hypocalcaemia</td>
                                    <td>10ml of 10%</td>
                                    <td>IV</td>
                                    <td>Cardioprotective, over 2-5 minutes</td>
                                </tr>
                                <tr>
                                    <td><strong>Sodium bicarbonate</strong></td>
                                    <td>Severe acidosis, hyperkalaemia</td>
                                    <td>50ml of 8.4%</td>
                                    <td>IV</td>
                                    <td>Only if indicated, not routine</td>
                                </tr>
                                <tr>
                                    <td><strong>Lidocaine</strong></td>
                                    <td>VF/VT (alternative)</td>
                                    <td>1mg/kg</td>
                                    <td>IV/IO</td>
                                    <td>If amiodarone unavailable</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div class="qr-critical-point">
                        ‚ö†Ô∏è <strong>Drug Administration:</strong> All cardiac arrest drugs via IV/IO. If no IV access, establish IO immediately. Do NOT delay CPR to give drugs - quality CPR and early defibrillation are priorities.
                    </div>
                </div>

                <!-- ECG TAB -->
                <div id="qr-ecg" class="quick-reference-tab-content">
                    <div class="qr-section">
                        <div class="qr-section-title">Shockable Rhythms</div>
                        
                        <div class="qr-rhythm-box shockable">
                            <h4>Ventricular Fibrillation (VF)</h4>
                            <ul>
                                <li><strong>Appearance:</strong> Chaotic, irregular waveform with no identifiable QRS complexes</li>
                                <li><strong>Rate:</strong> Cannot determine (chaotic electrical activity)</li>
                                <li><strong>Can be coarse or fine:</strong> Coarse VF (larger amplitude) more likely to respond to defibrillation</li>
                                <li><strong>Clinical:</strong> Cardiac arrest - no pulse, no cardiac output</li>
                                <li><strong>Treatment:</strong> Immediate defibrillation, CPR, adrenaline, amiodarone</li>
                            </ul>
                        </div>

                        <div class="qr-rhythm-box shockable">
                            <h4>Pulseless Ventricular Tachycardia (VT)</h4>
                            <ul>
                                <li><strong>Appearance:</strong> Broad QRS complexes (>0.12s), regular rhythm</li>
                                <li><strong>Rate:</strong> Usually 100-250/min</li>
                                <li><strong>Broad complexes:</strong> QRS width typically 0.16-0.20s or more</li>
                                <li><strong>Clinical:</strong> Cardiac arrest - no pulse despite organised rhythm on monitor</li>
                                <li><strong>Treatment:</strong> SAME as VF - immediate defibrillation</li>
                                <li><strong>Critical:</strong> MUST check pulse - if pulse present, it's VT with pulse (different treatment)</li>
                            </ul>
                        </div>
                    </div>

                    <div class="qr-section">
                        <div class="qr-section-title">Tachycardias (With Pulse)</div>
                        
                        <div class="qr-rhythm-box">
                            <h4>VT with Pulse (Unstable)</h4>
                            <ul>
                                <li><strong>Appearance:</strong> Broad QRS (>0.12s), regular, monomorphic</li>
                                <li><strong>Rate:</strong> 100-250/min</li>
                                <li><strong>Clinical:</strong> Pulse present but adverse features (shock, syncope, ischaemia, failure)</li>
                                <li><strong>Treatment:</strong> SYNCHRONISED cardioversion 120-150J</li>
                                <li><strong>Key point:</strong> SYNC mode ON (waits for R wave to avoid shocking on T wave)</li>
                            </ul>
                        </div>

                        <div class="qr-rhythm-box">
                            <h4>Atrial Fibrillation (AF)</h4>
                            <ul>
                                <li><strong>Appearance:</strong> Irregularly irregular rhythm, no P waves, fine fibrillatory baseline</li>
                                <li><strong>Rate:</strong> Variable ventricular response (can be fast 120-180/min)</li>
                                <li><strong>QRS:</strong> Narrow (unless aberrant conduction)</li>
                                <li><strong>Clinical:</strong> If fast with adverse features, needs cardioversion</li>
                                <li><strong>Treatment:</strong> SYNCHRONISED cardioversion 120-150J if unstable</li>
                            </ul>
                        </div>

                        <div class="qr-rhythm-box">
                            <h4>Supraventricular Tachycardia (SVT)</h4>
                            <ul>
                                <li><strong>Appearance:</strong> Narrow QRS (<0.12s), regular rhythm</li>
                                <li><strong>Rate:</strong> Usually 150-250/min</li>
                                <li><strong>P waves:</strong> Often hidden or retrograde</li>
                                <li><strong>Clinical:</strong> Palpitations, may have adverse features if very fast</li>
                                <li><strong>Treatment:</strong> Adenosine if stable, SYNCHRONISED cardioversion 70-120J if unstable</li>
                            </ul>
                        </div>
                    </div>

                    <div class="qr-section">
                        <div class="qr-section-title">Bradycardias</div>
                        
                        <div class="qr-rhythm-box">
                            <h4>Complete Heart Block (3rd Degree AV Block)</h4>
                            <ul>
                                <li><strong>Appearance:</strong> P waves and QRS complexes completely dissociated</li>
                                <li><strong>Atrial rate:</strong> Regular, 60-100/min</li>
                                <li><strong>Ventricular rate:</strong> Slow, regular, 20-50/min (escape rhythm)</li>
                                <li><strong>QRS:</strong> Often broad if ventricular escape</li>
                                <li><strong>Clinical:</strong> Syncope, heart failure, bradycardia with adverse features</li>
                                <li><strong>Treatment:</strong> Atropine may not work, transcutaneous pacing usually required</li>
                            </ul>
                        </div>

                        <div class="qr-rhythm-box">
                            <h4>Sinus Bradycardia</h4>
                            <ul>
                                <li><strong>Appearance:</strong> Normal P-QRS-T, just slow</li>
                                <li><strong>Rate:</strong> <60/min</li>
                                <li><strong>Clinical:</strong> May be physiological (athletes) or pathological</li>
                                <li><strong>Treatment:</strong> Only if adverse features - atropine or pacing</li>
                            </ul>
                        </div>
                    </div>

                    <div class="qr-section">
                        <div class="qr-section-title">Non-Shockable Arrest Rhythms</div>
                        
                        <div class="qr-rhythm-box">
                            <h4>Asystole</h4>
                            <ul>
                                <li><strong>Appearance:</strong> Flat line (no electrical activity)</li>
                                <li><strong>Check:</strong> Leads attached? Gain setting correct?</li>
                                <li><strong>Clinical:</strong> Cardiac arrest - worst prognosis</li>
                                <li><strong>Treatment:</strong> CPR, adrenaline, treat reversible causes. DO NOT shock.</li>
                            </ul>
                        </div>

                        <div class="qr-rhythm-box">
                            <h4>Pulseless Electrical Activity (PEA)</h4>
                            <ul>
                                <li><strong>Appearance:</strong> Organised electrical activity on monitor</li>
                                <li><strong>Clinical:</strong> NO pulse despite electrical activity</li>
                                <li><strong>Treatment:</strong> CPR, adrenaline, aggressively treat reversible causes (4Hs 4Ts)</li>
                                <li><strong>Note:</strong> DO NOT shock - not a shockable rhythm</li>
                            </ul>
                        </div>
                    </div>

                    <div class="qr-critical-point">
                        ‚ö†Ô∏è <strong>Always check for pulse!</strong> The monitor can show organised rhythm but patient may have no pulse (PEA). VT on monitor requires pulse check to determine if it's pulseless VT (defibrillation) or VT with pulse (cardioversion with SYNC).
                    </div>
                </div>

                <!-- ENERGY TAB -->
                <div id="qr-energy" class="quick-reference-tab-content">
                    <div class="qr-section">
                        <div class="qr-section-title">Defibrillation Energy Levels</div>
                        
                        <div class="qr-critical-point">
                            ‚ö†Ô∏è <strong>SYNC mode OFF</strong> for defibrillation (cardiac arrest - no pulse)
                        </div>

                        <table class="qr-energy-table">
                            <thead>
                                <tr>
                                    <th>Rhythm</th>
                                    <th>Initial Energy</th>
                                    <th>Subsequent Shocks</th>
                                    <th>Notes</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><strong>VF</strong></td>
                                    <td>150-200J</td>
                                    <td>150-360J</td>
                                    <td>Use same or higher energy for subsequent shocks</td>
                                </tr>
                                <tr>
                                    <td><strong>Pulseless VT</strong></td>
                                    <td>150-200J</td>
                                    <td>150-360J</td>
                                    <td>Treat as VF - SYNC OFF, no pulse</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div class="qr-section">
                        <div class="qr-section-title">Cardioversion Energy Levels</div>
                        
                        <div class="qr-critical-point">
                            ‚ö†Ô∏è <strong>SYNC mode ON</strong> for cardioversion (patient has pulse)
                        </div>

                        <table class="qr-energy-table">
                            <thead>
                                <tr>
                                    <th>Rhythm</th>
                                    <th>Initial Energy</th>
                                    <th>If Unsuccessful</th>
                                    <th>Notes</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><strong>VT with pulse</strong></td>
                                    <td>120-150J</td>
                                    <td>Increase in steps</td>
                                    <td>SYNC ON - patient has pulse</td>
                                </tr>
                                <tr>
                                    <td><strong>Atrial Fibrillation</strong></td>
                                    <td>120-150J</td>
                                    <td>Increase in steps to 200J</td>
                                    <td>May need amiodarone if fails</td>
                                </tr>
                                <tr>
                                    <td><strong>Atrial Flutter</strong></td>
                                    <td>70-120J</td>
                                    <td>Increase in steps</td>
                                    <td>Usually very responsive</td>
                                </tr>
                                <tr>
                                    <td><strong>SVT</strong></td>
                                    <td>70-120J</td>
                                    <td>Increase in steps to 150J</td>
                                    <td>Try adenosine first if stable</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div class="qr-section">
                        <div class="qr-section-title">Critical Decision Points</div>
                        
                        <div class="qr-algorithm-box">
                            <h4>SYNC vs NO SYNC Decision</h4>
                            <ul>
                                <li><strong>NO SYNC (Defibrillation):</strong>
                                    <ul>
                                        <li>Patient in cardiac arrest (no pulse)</li>
                                        <li>VF or pulseless VT</li>
                                        <li>Shock delivered immediately, any point in cycle</li>
                                        <li>Energy: 150-200J initial, up to 360J</li>
                                    </ul>
                                </li>
                                <li><strong>SYNC ON (Cardioversion):</strong>
                                    <ul>
                                        <li>Patient has pulse but unstable</li>
                                        <li>VT, AF, flutter, SVT with adverse features</li>
                                        <li>Shock synchronised with R wave (avoids T wave)</li>
                                        <li>Energy: Depends on rhythm (70-150J)</li>
                                        <li>Sedation required if conscious</li>
                                    </ul>
                                </li>
                            </ul>
                        </div>

                        <div class="qr-algorithm-box">
                            <h4>Energy Escalation Strategy</h4>
                            <ul>
                                <li>If first shock unsuccessful, use same or higher energy for next shock</li>
                                <li>Maximum energy available: Usually 360J (biphasic)</li>
                                <li>Don't reduce energy after failure - maintain or increase</li>
                                <li>Consider pad position if repeated failures</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- PACING TAB -->
                <div id="qr-pacing" class="quick-reference-tab-content">
                    <div class="qr-section">
                        <div class="qr-section-title">Indications for Transcutaneous Pacing</div>
                        
                        <div class="qr-algorithm-box">
                            <h4>When to Pace</h4>
                            <ul>
                                <li><strong>Symptomatic bradycardia</strong> not responding to atropine</li>
                                <li><strong>Complete heart block</strong> with adverse features</li>
                                <li><strong>Mobitz type II AV block</strong></li>
                                <li><strong>Third-degree AV block</strong> (especially with broad QRS)</li>
                                <li><strong>Any bradycardia</strong> with shock, syncope, myocardial ischaemia, or heart failure</li>
                            </ul>
                        </div>
                    </div>

                    <div class="qr-section">
                        <div class="qr-section-title">Setup Procedure</div>
                        
                        <div class="qr-algorithm-box">
                            <h4>Step-by-Step</h4>
                            <ol style="line-height: 2;">
                                <li><strong>Explain to patient</strong> (if conscious) - pacing can be uncomfortable</li>
                                <li><strong>Consider analgesia/sedation</strong> if conscious and time allows</li>
                                <li><strong>Apply pacing electrodes:</strong>
                                    <ul>
                                        <li>Anterior-posterior position preferred</li>
                                        <li>Or anterior-lateral (avoid breast tissue)</li>
                                        <li>Ensure good contact, dry skin</li>
                                    </ul>
                                </li>
                                <li><strong>Connect to pacing device</strong></li>
                                <li><strong>Select PACER mode</strong> on defibrillator</li>
                                <li><strong>Set pacing rate:</strong> 60-70/min initially</li>
                                <li><strong>Increase output</strong> from zero until capture achieved</li>
                                <li><strong>Confirm capture:</strong> Check for palpable pulse matching paced rate</li>
                                <li><strong>Set output 10-20mA above threshold</strong> to ensure consistent capture</li>
                            </ol>
                        </div>
                    </div>

                    <div class="qr-section">
                        <div class="qr-section-title">Pacing Parameters</div>
                        
                        <table class="qr-drug-table">
                            <thead>
                                <tr>
                                    <th>Parameter</th>
                                    <th>Range</th>
                                    <th>Initial Setting</th>
                                    <th>Notes</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><strong>Rate</strong></td>
                                    <td>30-200 ppm</td>
                                    <td>60-70 ppm</td>
                                    <td>Can increase if needed for perfusion</td>
                                </tr>
                                <tr>
                                    <td><strong>Output</strong></td>
                                    <td>0-200 mA</td>
                                    <td>Start at 0, increase</td>
                                    <td>Threshold typically 50-100mA</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div class="qr-section">
                        <div class="qr-section-title">Confirming Electrical Capture</div>
                        
                        <div class="qr-algorithm-box">
                            <h4>Signs of Capture</h4>
                            <ul>
                                <li><strong>ECG:</strong> Pacing spike followed by wide QRS complex</li>
                                <li><strong>Most important:</strong> Palpable pulse matching paced rate</li>
                                <li><strong>Blood pressure:</strong> Should improve if capture achieved</li>
                                <li><strong>Patient perfusion:</strong> Improved conscious level, color</li>
                            </ul>
                        </div>

                        <div class="qr-critical-point">
                            ‚ö†Ô∏è <strong>Electrical vs Mechanical Capture:</strong> Just seeing paced QRS complexes isn't enough! You MUST check for a palpable pulse at the paced rate to confirm mechanical capture and cardiac output.
                        </div>
                    </div>

                    <div class="qr-section">
                        <div class="qr-section-title">Troubleshooting</div>
                        
                        <div class="qr-algorithm-box">
                            <h4>If No Capture</h4>
                            <ul>
                                <li>Increase output (up to maximum 200mA)</li>
                                <li>Check electrode contact and position</li>
                                <li>Try different pad position (anterior-posterior if was anterior-lateral)</li>
                                <li>Consider severe hyperkalemia or other metabolic causes</li>
                                <li>May need transvenous pacing if transcutaneous fails</li>
                            </ul>
                        </div>

                        <div class="qr-algorithm-box">
                            <h4>Patient Discomfort</h4>
                            <ul>
                                <li>Transcutaneous pacing causes muscle stimulation - can be painful</li>
                                <li>Provide analgesia/sedation if patient conscious</li>
                                <li>Fentanyl 25-50mcg IV or midazolam 1-2mg IV</li>
                                <li>Explain procedure and sensations to patient</li>
                                <li>Reassure patient this is temporary measure</li>
                            </ul>
                        </div>
                    </div>

                    <div class="qr-section">
                        <div class="qr-section-title">Medication During Pacing</div>
                        
                        <div class="qr-algorithm-box">
                            <h4>Concurrent Therapies</h4>
                            <ul>
                                <li><strong>Atropine:</strong> Give before pacing if not already tried (500mcg, up to 3mg total)</li>
                                <li><strong>Analgesia:</strong> Fentanyl 25-100mcg IV for pain from pacing</li>
                                <li><strong>Sedation:</strong> Midazolam 1-5mg IV if needed and BP stable</li>
                                <li><strong>Treat cause:</strong> e.g., if inferior MI consider fluids, avoid bradycardia treatments that reduce preload</li>
                                <li><strong>Expert help:</strong> Call for transvenous pacing if transcutaneous pacing required for >30 minutes</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</body>
</html>
