<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ZOLL R Series Simulator - WMEBEM | RCUK 2025 (Full Site, Crisp ECG)</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:Arial,Helvetica,sans-serif;background:#2a2a2a;padding:20px;min-height:100vh}
    .menu-wrapper{display:flex;justify-content:center;align-items:center}
    .menu-screen{display:none;flex-direction:column;align-items:center;justify-content:center;background:linear-gradient(135deg,#2c3e50 0%,#34495e 100%);border-radius:15px;padding:40px;max-width:1000px;box-shadow:0 20px 60px rgba(0,0,0,0.5);margin:0 auto 20px auto}
    #modeSelectScreen{display:flex}
    .menu-logo{margin-bottom:20px}
    .menu-logo img{height:70px;background:#fff;padding:10px 18px;border-radius:10px}
    .menu-title{text-align:center;margin-bottom:24px}
    .menu-title h1{color:#ecf0f1;font-size:32px;margin-bottom:10px}
    .menu-title p{color:#bdc3c7;font-size:16px}
    .menu-options{display:grid;grid-template-columns:1fr 1fr;gap:20px;width:100%;max-width:900px}
    .menu-option{background:linear-gradient(180deg,#3498db 0%,#2874a6 100%);color:#fff;border:none;padding:28px 24px;border-radius:15px;font-size:20px;font-weight:bold;cursor:pointer;transition:all .2s;text-align:center;box-shadow:0 10px 25px rgba(0,0,0,0.3)}
    .menu-option:hover{transform:translateY(-4px)}
    .quick-rhythm-panel{background:linear-gradient(135deg,#2c3e50 0%,#34495e 100%);border-radius:10px;padding:16px;margin:0 auto 20px auto;max-width:1600px;border:3px solid #1a252f}
    .quick-rhythm-panel h4{color:#3498db;font-size:14px;margin-bottom:10px;text-transform:uppercase;text-align:center}
    .rhythm-buttons{display:grid;grid-template-columns:repeat(auto-fit,minmax(80px,1fr));gap:6px}
    .rhythm-btn{background:#34495e;color:#ecf0f1;border:2px solid #2c3e50;padding:8px;border-radius:6px;font-size:11px;cursor:pointer}
    .rhythm-btn.active{background:#2980b9;border-color:#1f5f8b}
    .simulator-container{max-width:1600px;width:100%;margin:0 auto}
    .back-button{background:#e74c3c;color:#fff;border:none;padding:12px 20px;border-radius:8px;font-size:14px;font-weight:bold;cursor:pointer;margin-bottom:10px;display:inline-flex;align-items:center;gap:10px;box-shadow:0 4px 10px rgba(0,0,0,0.3)}
    .reset-button{background:#3498db;margin-left:10px}
    .instructor-panel{background:linear-gradient(135deg,#2c3e50 0%,#34495e 100%);border-radius:10px;padding:18px;margin-bottom:20px;border:3px solid #1a252f}
    .instructor-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
    .instructor-title h2{color:#ecf0f1;font-size:16px}
    .instructor-title p{color:#bdc3c7;font-size:12px;margin-top:4px}
    .control-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:12px;margin-top:8px}
    .control-section{background:#2c3e50;padding:12px;border-radius:8px}
    .control-section h4{color:#3498db;font-size:12px;margin-bottom:8px;text-transform:uppercase}
    .control-row{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;padding:8px;background:#34495e;border-radius:6px;color:#ecf0f1;font-size:12px}
    .control-row input,.control-row select{width:110px;padding:6px;border-radius:4px;border:1px solid #2c3e50;background:#2c3e50;color:#00ff00;font-weight:bold}
    .zoll-device{background:#c8d0d8;border:20px solid #2b7bbf;border-radius:25px;padding:30px;box-shadow:0 20px 60px rgba(0,0,0,0.5);position:relative;display:grid;grid-template-columns:1.2fr .8fr;gap:20px;max-width:1400px;margin:0 auto}
    .zoll-top-logo{position:absolute;top:25px;right:30px;height:40px;background:#fff;padding:6px;border-radius:8px;z-index:10}
    .device-screen-section{background:#a8b0b8;padding:20px;border-radius:15px;box-shadow:inset 0 4px 10px rgba(0,0,0,0.2)}
    .screen{background:#000;border-radius:10px;padding:12px;margin-bottom:12px;box-shadow:inset 0 0 20px rgba(0,0,0,0.8);position:relative}
    .screen-header{display:flex;justify-content:space-between;padding:6px;background:rgba(0,0,0,0.6);border-radius:5px;margin-bottom:8px}
    .screen-info{color:#00ffff;font-size:12px;font-family:'Courier New',monospace;text-shadow:0 0 5px rgba(0,255,255,0.5)}
    .screen-info.sync{color:#ffff00;font-weight:bold;animation:blink 1s infinite}
    .ecg-canvas-container{background:#000;height:320px;border-radius:8px;position:relative;overflow:hidden;margin-bottom:10px}
    canvas{width:100%;height:100%}
    .sync-tick{position:absolute;top:0;width:2px;height:12px;background:#fff;opacity:.9}
    .vitals-display{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;padding:12px;background:rgba(0,0,0,0.6);border-radius:8px}
    .vital-item{text-align:center}
    .vital-label{color:#888;font-size:10px;margin-bottom:3px}
    .vital-value{color:#00ff00;font-size:34px;font-weight:bold;font-family:'Courier New',monospace;text-shadow:0 0 10px rgba(0,255,0,0.6)}
    .vital-unit{color:#888;font-size:11px;margin-top:2px}
    .message-bar{background:rgba(0,0,0,0.8);color:#ffff00;padding:10px;text-align:center;border-radius:6px;font-family:'Courier New',monospace;font-size:13px;font-weight:bold;margin-top:8px}
    .message-bar.ready{color:#00ff00;text-shadow:0 0 5px rgba(0,255,0,0.5)}
    .device-controls-section{display:flex;flex-direction:column;gap:12px}
    .top-buttons{display:grid;grid-template-columns:auto 1fr;gap:12px;align-items:start}
    .btn-sync{background:#f39c12;color:#fff;border:3px solid #d68910;padding:12px 16px;border-radius:8px;font-size:13px;font-weight:bold;cursor:pointer}
    .btn-sync.active{background:#e67e22;box-shadow:0 0 12px rgba(230,126,34,.7)}
    .btn-shock{background:linear-gradient(135deg,#ff6347 0%,#ff4520 100%);color:#fff;border:5px solid #cc4f39;width:120px;height:120px;border-radius:50%;font-size:18px;font-weight:bold;cursor:pointer;display:flex;flex-direction:column;align-items:center;justify-content:center;position:relative}
    .btn-shock:disabled{opacity:.5;cursor:not-allowed}
    .btn-shock .number{position:absolute;bottom:10px;left:50%;transform:translateX(-50%);font-size:16px}
    .side-buttons{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .side-btn{background:#7a8288;color:#fff;border:3px solid #6a7278;padding:10px;border-radius:8px;font-size:12px;font-weight:bold;cursor:pointer}
    .btn-analyze,.btn-charge{background:linear-gradient(180deg,#ff9933 0%,#ff7700 100%);color:#000;border:4px solid #cc6600;padding:14px;border-radius:10px;font-size:15px;font-weight:bold;cursor:pointer;display:flex;align-items:center;justify-content:space-between}
    .btn-number{background:#fff;color:#ff7700;width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:16px;font-weight:bold}
    .energy-selector{background:linear-gradient(180deg,#dc3545 0%,#c82333 100%);color:#fff;border:4px solid #a71d2a;padding:14px;border-radius:10px;display:flex;flex-direction:column;align-items:center;gap:6px}
    .energy-display{font-size:30px;font-weight:bold;text-shadow:0 2px 4px rgba(0,0,0,0.3)}
    .energy-arrows{display:flex;gap:12px}
    .energy-arrow{background:#fff;color:#dc3545;width:38px;height:38px;border-radius:50%;border:none;font-size:20px;cursor:pointer;display:flex;align-items:center;justify-content:center}
    .mode-dial-container{text-align:center;padding:12px;background:#a8b0b8;border-radius:12px}
    .mode-labels{display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:11px;font-weight:bold;color:#2a2a2a}
    .mode-label{padding:10px 12px;border-radius:8px;cursor:pointer;background:#34495e;color:#ecf0f1;border:3px solid #2c3e50;text-transform:uppercase}
    .mode-label.active{background:linear-gradient(180deg,#3498db 0%,#2874a6 100%);border-color:#1f5f8b;box-shadow:0 0 12px rgba(52,152,219,.5)}
    .pacing-controls{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .pacer-dial{background:#2a2a2a;border:5px solid #0a0a0a;border-radius:50%;width:100px;height:100px;margin:0 auto;position:relative;cursor:pointer;box-shadow:0 4px 8px rgba(0,0,0,0.5)}
    .pacer-label{text-align:center;color:#2a2a2a;font-size:11px;font-weight:bold;margin-top:8px}
    .pacer-value{text-align:center;color:#17a2b8;font-size:20px;font-weight:bold;margin-top:4px}
    .pacer-controls-btn{display:flex;gap:5px;justify-content:center;margin-top:8px}
    .pacer-btn{background:#7a8288;color:#fff;border:2px solid #6a7278;width:35px;height:35px;border-radius:5px;font-size:18px;cursor:pointer}
    .zoll-branding{background:linear-gradient(180deg,#e8eef3 0%,#d8dee3 100%);padding:18px;border-radius:0 0 15px 15px;margin:-30px -30px 0 -30px;text-align:center;box-shadow:0 -4px 10px rgba(0,0,0,0.1)}
    .zoll-logo-text{font-size:44px;font-weight:bold;color:#9a9a9a;letter-spacing:8px}
    @keyframes blink{0%,50%{opacity:1}51%,100%{opacity:.3}}
    @media (max-width:1200px){.zoll-device{grid-template-columns:1fr}}
    @media print{body{background:#fff;padding:0}.menu-screen{display:block !important;box-shadow:none;padding:0;background:#fff}.menu-option{display:none !important}#certificateContent{box-shadow:none}}
  </style>
</head>
<body>

  <!-- Mode select -->
  <div class="menu-screen" id="modeSelectScreen">
    <div class="menu-logo"><img src="https://iili.io/KGQOvkl.md.png" alt="WMEBEM Logo"></div>
    <div class="menu-title"><h1>ZOLL R Series Simulator</h1><p>Select a Scenario Mode</p></div>
    <div class="menu-options">
      <button class="menu-option" onclick="selectMode('education')">
        <div>Education Mode</div><div class="subtitle">Instructor controls visible for teaching</div>
      </button>
      <button class="menu-option" onclick="selectMode('testing')">
        <div>Testing Mode</div><div class="subtitle">Learner assessment with hidden controls</div>
      </button>
    </div>
  </div>

  <!-- Quick rhythm strip always available -->
  <div class="quick-rhythm-panel" id="quickRhythmPanel">
    <h4>Quick Rhythm Select</h4>
    <div class="rhythm-buttons">
      <button class="rhythm-btn active" data-rhythm="nsr" onclick="quickSetRhythm('nsr')">NSR</button>
      <button class="rhythm-btn" data-rhythm="vfib" onclick="quickSetRhythm('vfib')">VF</button>
      <button class="rhythm-btn" data-rhythm="vtach" onclick="quickSetRhythm('vtach')">VT</button>
      <button class="rhythm-btn" data-rhythm="svt" onclick="quickSetRhythm('svt')">SVT</button>
      <button class="rhythm-btn" data-rhythm="afib" onclick="quickSetRhythm('afib')">AF</button>
      <button class="rhythm-btn" data-rhythm="sinus_brady" onclick="quickSetRhythm('sinus_brady')">SB</button>
      <button class="rhythm-btn" data-rhythm="sinus_tach" onclick="quickSetRhythm('sinus_tach')">ST</button>
      <button class="rhythm-btn" data-rhythm="asystole" onclick="quickSetRhythm('asystole')">ASY</button>
      <button class="rhythm-btn" data-rhythm="chb" onclick="quickSetRhythm('chb')">CHB</button>
      <button class="rhythm-btn" data-rhythm="paced" onclick="quickSetRhythm('paced')">PACED</button>
      <button class="rhythm-btn" data-rhythm="idioventricular" onclick="quickSetRhythm('idioventricular')">IVR</button>
    </div>
  </div>

  <!-- Scenario select -->
  <div class="menu-screen" id="scenarioScreen">
    <div class="menu-logo"><img src="https://iili.io/KGQOvkl.md.png" alt="WMEBEM Logo"></div>
    <div class="menu-title"><h1 id="modeTitle">Education Mode</h1><p>Select a clinical scenario</p></div>
    <div style="max-width: 1000px; display: grid; gap: 15px; width: 100%;">
      <div style="background:#2c3e50;padding:20px;border-radius:10px">
        <h3 style="color:#e74c3c;margin-bottom:10px;font-size:18px">Defibrillation (Cardiac Arrest)</h3>
        <div style="display:grid;gap:10px">
          <button class="menu-option" style="padding:18px;text-align:left" onclick="selectScenario('vf-arrest')">
            <div style="font-size:16px">Ventricular Fibrillation</div><div class="subtitle">Coarse VF requiring immediate defibrillation</div>
          </button>
          <button class="menu-option" style="padding:18px;text-align:left" onclick="selectScenario('pulseless-vt')">
            <div style="font-size:16px">Pulseless VT</div><div class="subtitle">Broad complex tachycardia with no pulse, treat as VF</div>
          </button>
        </div>
      </div>

      <div style="background:#2c3e50;padding:20px;border-radius:10px">
        <h3 style="color:#f39c12;margin-bottom:10px;font-size:18px">Cardioversion (With Pulse)</h3>
        <div style="display:grid;gap:10px">
          <button class="menu-option" style="padding:18px;text-align:left" onclick="selectScenario('unstable-vt')">
            <div style="font-size:16px">VT with Pulse, Unstable</div><div class="subtitle">Requires synchronised shock</div>
          </button>
          <button class="menu-option" style="padding:18px;text-align:left" onclick="selectScenario('unstable-svt')">
            <div style="font-size:16px">SVT with Adverse Features</div><div class="subtitle">Requires synchronised shock</div>
          </button>
          <button class="menu-option" style="padding:18px;text-align:left" onclick="selectScenario('fast-af')">
            <div style="font-size:16px">Fast AF with Adverse Features</div><div class="subtitle">Requires synchronised shock</div>
          </button>
        </div>
      </div>

      <div style="background:#2c3e50;padding:20px;border-radius:10px">
        <h3 style="color:#3498db;margin-bottom:10px;font-size:18px">Transcutaneous Pacing</h3>
        <div style="display:grid;gap:10px">
          <button class="menu-option" style="padding:18px;text-align:left" onclick="selectScenario('complete-hb')">
            <div style="font-size:16px">Complete Heart Block</div><div class="subtitle">Requires pacing</div>
          </button>
          <button class="menu-option" style="padding:18px;text-align:left" onclick="selectScenario('symptomatic-brady')">
            <div style="font-size:16px">Symptomatic Bradycardia</div><div class="subtitle">Requires pacing</div>
          </button>
        </div>
      </div>
    </div>
    <button class="back-button" onclick="backToModeSelect()" style="margin-top: 16px">‚óÄ Back</button>
  </div>

  <!-- Summary screen -->
  <div class="menu-screen" id="summaryScreen">
    <div class="menu-logo"><img src="https://iili.io/KGQOvkl.md.png" alt="WMEBEM Logo"></div>
    <div class="menu-title"><h1>Scenario Complete</h1><p>Defibrillator Performance Summary</p></div>
    <div style="max-width:1000px;width:100%;display:grid;gap:18px">
      <div style="background:#2c3e50;padding:18px;border-radius:10px">
        <h3 style="color:#3498db;font-size:18px;margin-bottom:10px">Scenario</h3>
        <div id="summaryScenarioName" style="color:#ecf0f1;font-size:16px;font-weight:bold;margin-bottom:6px"></div>
        <div id="summaryScenarioDesc" style="color:#bdc3c7;font-size:14px;line-height:1.6"></div>
      </div>
      <div style="background:#2c3e50;padding:18px;border-radius:10px">
        <h3 style="color:#3498db;font-size:18px;margin-bottom:10px">Device Actions Performed</h3>
        <div id="summaryActions" style="color:#ecf0f1;font-size:14px;line-height:1.8"></div>
      </div>
      <div style="background:#2c3e50;padding:18px;border-radius:10px">
        <h3 style="color:#3498db;font-size:18px;margin-bottom:10px">Performance Feedback</h3>
        <div id="summaryFeedback" style="font-size:14px;line-height:1.8"></div>
      </div>
      <div style="background:#2c3e50;padding:18px;border-radius:10px">
        <h3 style="color:#3498db;font-size:18px;margin-bottom:10px">Patient Outcome</h3>
        <div id="summaryOutcome" style="color:#ecf0f1;font-size:15px;line-height:1.6"></div>
      </div>
    </div>
    <div style="display:flex;gap:12px;margin-top:16px;justify-content:center;flex-wrap:wrap">
      <button class="menu-option" onclick="tryAgain()" style="padding:16px 32px">üîÑ Try Again</button>
      <button class="menu-option" onclick="printCertificate()" style="padding:16px 32px">üìÑ Print Certificate</button>
      <button class="menu-option" onclick="returnToMenu()" style="padding:16px 32px">‚Ü© Main Menu</button>
    </div>
  </div>

  <!-- Certificate screen -->
  <div class="menu-screen" id="certificateScreen" style="max-width:900px">
    <div id="certificateContent" style="background:#fff;padding:50px;border-radius:15px;color:#2c3e50;position:relative">
      <div style="border:8px solid #3498db;padding:32px;border-radius:10px">
        <div style="text-align:center;margin-bottom:20px">
          <img src="https://iili.io/KGQOvkl.md.png" alt="WMEBEM Logo" style="height:60px;margin-bottom:16px">
          <h1 style="color:#2c3e50;font-size:38px;margin-bottom:10px">Certificate of Completion</h1>
          <div style="width:100px;height:3px;background:#3498db;margin:16px auto"></div>
        </div>
        <div style="text-align:center;margin:28px 0">
          <p style="font-size:16px;color:#7f8c8d;margin-bottom:14px">This certifies that the learner has successfully completed</p>
          <h2 id="certScenarioName" style="color:#2c3e50;font-size:28px;margin:14px 0;font-weight:bold"></h2>
          <p style="font-size:15px;color:#7f8c8d">ZOLL R Series Defibrillator Training</p>
        </div>
        <div style="background:#ecf0f1;padding:18px;border-radius:8px;margin:24px 0">
          <h3 style="color:#2c3e50;font-size:18px;margin-bottom:10px;text-align:center">Performance Summary</h3>
          <div id="certPerformance" style="font-size:14px;line-height:2"></div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-top:20px">
          <div style="text-align:center">
            <div style="border-top:2px solid #2c3e50;padding-top:8px;margin:0 20px">
              <p id="certDate" style="font-size:14px;color:#7f8c8d"></p>
              <p style="font-size:12px;color:#95a5a6;margin-top:5px">Date</p>
            </div>
          </div>
          <div style="text-align:center">
            <div style="border-top:2px solid #2c3e50;padding-top:8px;margin:0 20px">
              <p style="font-size:14px;color:#7f8c8d">WMEBEM Training</p>
              <p style="font-size:12px;color:#95a5a6;margin-top:5px">Authorised By</p>
            </div>
          </div>
        </div>
        <div style="text-align:center;margin-top:20px;padding-top:16px;border-top:1px solid #bdc3c7">
          <p style="font-size:12px;color:#95a5a6">RCUK 2025 Guidelines | Simulation Training Exercise</p>
        </div>
      </div>
    </div>
    <div style="display:flex;gap:12px;margin-top:16px;justify-content:center">
      <button class="menu-option" onclick="window.print()" style="padding:14px 26px">üñ®Ô∏è Print</button>
      <button class="menu-option" onclick="backToSummary()" style="padding:14px 26px">‚Üê Back to Summary</button>
    </div>
  </div>

  <!-- Simulator container -->
  <div class="simulator-container" id="simulatorContainer">
    <button class="back-button" onclick="endScenario()" id="btnEndScenario" style="display:none">‚óÄ End Scenario</button>
    <button class="back-button reset-button" onclick="resetScenario()" id="btnResetScenario" style="display:none">üîÑ Reset Scenario</button>

    <div class="instructor-panel" id="instructorPanel" style="display:none">
      <div class="instructor-header">
        <div class="instructor-title"><h2>Instructor Controls</h2><p id="instructorSubtitle">Scenario in progress</p></div>
      </div>
      <div class="control-grid">
        <div class="control-section">
          <h4>Quick Rhythm Change</h4>
          <div class="rhythm-buttons">
            <button class="rhythm-btn" data-rhythm="nsr" onclick="quickSetRhythm('nsr')">NSR</button>
            <button class="rhythm-btn" data-rhythm="vfib" onclick="quickSetRhythm('vfib')">VF</button>
            <button class="rhythm-btn" data-rhythm="vtach" onclick="quickSetRhythm('vtach')">VT</button>
            <button class="rhythm-btn" data-rhythm="svt" onclick="quickSetRhythm('svt')">SVT</button>
            <button class="rhythm-btn" data-rhythm="afib" onclick="quickSetRhythm('afib')">AF</button>
            <button class="rhythm-btn" data-rhythm="sinus_brady" onclick="quickSetRhythm('sinus_brady')">SB</button>
            <button class="rhythm-btn" data-rhythm="sinus_tach" onclick="quickSetRhythm('sinus_tach')">ST</button>
            <button class="rhythm-btn" data-rhythm="asystole" onclick="quickSetRhythm('asystole')">ASY</button>
            <button class="rhythm-btn" data-rhythm="chb" onclick="quickSetRhythm('chb')">CHB</button>
            <button class="rhythm-btn" data-rhythm="paced" onclick="quickSetRhythm('paced')">PACED</button>
            <button class="rhythm-btn" data-rhythm="idioventricular" onclick="quickSetRhythm('idioventricular')">IVR</button>
          </div>
        </div>
        <div class="control-section">
          <h4>Artefact Overlays</h4>
          <div class="control-row"><label>Movement</label><input type="checkbox" onchange="toggleArtefact('movement', this.checked)"></div>
          <div class="control-row"><label>CPR ongoing</label><input type="checkbox" onchange="toggleArtefact('cpr', this.checked)"></div>
          <div class="control-row"><label>Lead-off</label><input type="checkbox" onchange="toggleArtefact('leadoff', this.checked)"></div>
        </div>
        <div class="control-section">
          <h4>Pacing</h4>
          <div class="control-row"><span>Output (mA)</span><div><button class="pacer-btn" onclick="adjustPacer('output', -10)">-</button><span id="outputDisplay" style="margin:0 8px;color:#17a2b8;font-weight:bold">0</span><button class="pacer-btn" onclick="adjustPacer('output', 10)">+</button></div></div>
          <div class="control-row"><span>Rate (ppm)</span><div><button class="pacer-btn" onclick="adjustPacer('rate', -10)">-</button><span id="rateDisplay" style="margin:0 8px;color:#17a2b8;font-weight:bold">60</span><button class="pacer-btn" onclick="adjustPacer('rate', 10)">+</button></div></div>
        </div>
        <div class="control-section">
          <h4>Status</h4>
          <div class="control-row"><span>Shocks</span><strong id="shockCounter" style="color:#ecf0f1">0</strong></div>
          <div class="control-row"><span>Sync mode</span><strong id="syncStatus" style="color:#ecf0f1">OFF</strong></div>
          <div class="control-row"><span>Pacing</span><strong id="pacingStatus" style="color:#ecf0f1">OFF</strong></div>
        </div>
      </div>
    </div>

    <div class="zoll-device" id="zollDevice" style="display:grid">
      <img class="zoll-top-logo" src="https://iili.io/KGQOvkl.md.png" alt="WMEBEM Logo">
      <div class="device-screen-section">
        <div class="screen">
          <div class="screen-header">
            <div class="screen-info" id="leadInfo">LEAD: II</div>
            <div class="screen-info" id="syncIndicator"></div>
            <div class="screen-info" id="modeInfo">MODE: MONITOR</div>
            <div class="screen-info" id="timeInfo">00:00:00</div>
          </div>
          <div class="ecg-canvas-container"><canvas id="ecgCanvas"></canvas></div>
          <div class="vitals-display">
            <div class="vital-item"><div class="vital-label">HR</div><div class="vital-value" id="hrDisplay">75</div><div class="vital-unit">bpm</div></div>
            <div class="vital-item"><div class="vital-label">SpO‚ÇÇ</div><div class="vital-value" id="spo2Display">98</div><div class="vital-unit">%</div></div>
            <div class="vital-item"><div class="vital-label">ETCO‚ÇÇ</div><div class="vital-value" id="etco2Display">38</div><div class="vital-unit">mmHg</div></div>
            <div class="vital-item"><div class="vital-label">NIBP</div><div class="vital-value" id="bpDisplay" style="font-size:24px">120/80</div><div class="vital-unit">mmHg</div></div>
          </div>
          <div class="message-bar ready" id="messageBar">SIMULATOR READY</div>
        </div>
        <div style="display:flex;gap:10px;margin-top:8px">
          <button class="side-btn" onclick="checkPulse()">Check Pulse</button>
          <button class="side-btn">Param</button>
          <button class="side-btn">Marker</button>
          <button class="side-btn">Alarms</button>
        </div>
      </div>

      <div class="device-controls-section">
        <div class="top-buttons">
          <button class="btn-sync" id="syncBtn" onclick="toggleSync()">SYNC</button>
          <button class="btn-shock" id="shockBtn" onclick="deliverShock()" disabled>SHOCK<span class="number">3</span></button>
        </div>
        <div class="side-buttons">
          <button class="side-btn">LEAD</button><button class="side-btn">SIZE</button>
          <button class="side-btn">ALARM SUSPEND</button><button class="side-btn">RECORDER</button>
        </div>
        <button class="btn-analyze" onclick="analyseRhythm()"><span>ANALYSE</span><span class="btn-number">2</span></button>
        <button class="btn-charge" id="chargeBtn" onclick="chargeDefib()"><span>CHARGE</span><span class="btn-number">2</span></button>
        <div class="energy-selector">
          <div style="font-size:11px">ENERGY SELECT</div>
          <div class="energy-display" id="energyDisplay">120</div>
          <div style="font-size:12px">JOULES</div>
          <div class="energy-arrows">
            <button class="energy-arrow" onclick="adjustEnergy(-1)">‚ñº</button>
            <button class="energy-arrow" onclick="adjustEnergy(1)">‚ñ≤</button>
          </div>
          <div class="btn-number" style="margin-top:-5px">1</div>
        </div>
        <div class="mode-dial-container">
          <div class="mode-labels">
            <div class="mode-label active" data-mode="monitor" onclick="setMode('monitor')">MONITOR</div>
            <div class="mode-label" data-mode="defib" onclick="setMode('defib')">DEFIB</div>
            <div class="mode-label" data-mode="pacer" onclick="setMode('pacer')">PACER</div>
            <div class="mode-label" data-mode="off" onclick="setMode('off')">OFF</div>
          </div>
        </div>
        <div class="pacing-controls">
          <div>
            <div class="pacer-label">OUTPUT</div><div class="pacer-dial"></div>
            <div class="pacer-value" id="outputDisplay2">0</div><div class="pacer-label">mA</div>
            <div class="pacer-controls-btn"><button class="pacer-btn" onclick="adjustPacer('output', -10)">-</button><button class="pacer-btn" onclick="adjustPacer('output', 10)">+</button></div>
          </div>
          <div>
            <div class="pacer-label">RATE</div><div class="pacer-dial"></div>
            <div class="pacer-value" id="rateDisplay2">60</div><div class="pacer-label">ppm</div>
            <div class="pacer-controls-btn"><button class="pacer-btn" onclick="adjustPacer('rate', -10)">-</button><button class="pacer-btn" onclick="adjustPacer('rate', 10)">+</button></div>
          </div>
        </div>
      </div>

      <div class="zoll-branding"><div class="zoll-logo-text">ZOLL</div></div>
    </div>
  </div>

  <!-- ECG Rhythm Engine (inline, crisp grid lines) -->
  <script>
  /*! WMEBEM ECG Rhythm Engine v1.0 (Crisp) */
  (function () {
    'use strict';
    const PX_PER_BIG=25,PX_PER_MM=PX_PER_BIG/5,PX_PER_MV=PX_PER_MM*10; let ECG_SPEED=PX_PER_BIG*5;
    function setSpeed(px){ECG_SPEED=px} const clamp=(v,lo,hi)=>Math.max(lo,Math.min(hi,v)),lerp=(a,b,t)=>a+(b-a)*t;
    function perlinLikeNoise(x,freq,amp){const a=Math.sin(x*freq*.71)*.5+.5,b=Math.sin(x*freq*1.33+1.7)*.5+.5;return (a*.6+b*.4-.5)*2*amp}
    function baselineWander(t){return Math.sin(t*.25)*(PX_PER_MM*.6)} function movementArtefact(x,t){return Math.sin((x+t*120)*.05)*(PX_PER_MM*1)}
    function leadoffArtefact(t){return Math.sin(t*1.2)*(PX_PER_MM*1.5)} function cprArtefact(x,t){const f=2;return Math.sin(2*Math.PI*f*t)*(PX_PER_MV*.6)+perlinLikeNoise(x+t*60,.03,PX_PER_MM*2)}
    function pWave(s,amp=.1){const a= Math.max(0,Math.min(1,Math.sin(Math.PI*s)));return -a*(PX_PER_MV*amp)}
    function qrsNarrow(s,rAmp=1,qAmp=.15,sAmp=.25){if(s<.22){const t=s/.22;return PX_PER_MV*qAmp*(t*.4)}else if(s<.55){const t=(s-.22)/.33;return -PX_PER_MV*rAmp*(Math.sin(t*Math.PI))}else{const t=(s-.55)/.45;return PX_PER_MV*sAmp*(Math.sin(t*Math.PI))}}
    function qrsWide(s,rAmp=.9){if(s<.35){const t=s/.35;return -PX_PER_MV*rAmp*(t*.9)}else if(s<.7){const t=(s-.35)/.35;return -PX_PER_MV*rAmp*(.9-.2*t)}else{const t=(s-.7)/.3;return -PX_PER_MV*rAmp*(.7-.7*t)}}
    function tWave(s,amp=.3){if(s<.45){const t=s/.45;return -PX_PER_MV*amp*Math.sin(t*Math.PI*.6)}else{const t=(s-.45)/.55;return -PX_PER_MV*amp*(Math.cos(t*Math.PI)*.8)}}
    function sinusTemplate(x,hr,h,t,opts={}){const base=h/2,bpm=hr>0?hr:75,rr=1+perlinLikeNoise(x,.0008,.02),cycle=(60/bpm)*ECG_SPEED*rr,pos=x%cycle,s=pos/cycle;let y=0;
      const pDur=.08*ECG_SPEED/cycle,prEnd=pDur+.10*ECG_SPEED/cycle,qrsDur=.09*ECG_SPEED/cycle,qrsStart=prEnd,qrsEnd=qrsStart+qrsDur,tEnd=qrsEnd+.16*ECG_SPEED/cycle;
      if(s<pDur){y+=pWave(s/pDur, opts.pAmp??.1)} else if(s<prEnd){} else if(s<qrsEnd){y+=qrsNarrow((s-qrsStart)/(qrsDur), opts.rAmp??1, opts.qAmp??.15, opts.sAmp??.25)}
      else if(s<tEnd){y+=tWave((s-qrsEnd)/(tEnd-qrsEnd), opts.tAmp??.3)} y*=1+perlinLikeNoise(x,.002,.05); return base+y;}
    function nsr(x,hr,t,c){return sinusTemplate(x,hr||75,c.height,t,{})}
    function sinusBrady(x,hr,t,c){return sinusTemplate(x,hr||45,c.height,t,{rAmp:.9,tAmp:.25})}
    function sinusTach(x,hr,t,c){return sinusTemplate(x,hr||120,c.height,t,{rAmp:1.1,tAmp:.35})}
    function svt(x,hr,t,c){const base=c.height/2,bpm=hr>0?hr:190,cycle=(60/bpm)*ECG_SPEED,pos=x%cycle,s=pos/cycle;let y=0;
      const pr=.06*ECG_SPEED/cycle,qrs=.08*ECG_SPEED/cycle,qrsEnd=pr+qrs,tEnd=qrsEnd+.14*ECG_SPEED/cycle;
      if(s<pr){y+=pWave(s/pr,.05)} else if(s<qrsEnd){y+=qrsNarrow((s-pr)/qrs,.95,.1,.2)} else if(s<tEnd){y+=tWave((s-qrsEnd)/(tEnd-qrsEnd),.25)}
      y*=1+perlinLikeNoise(x,.0025,.05); return base+y;}
    function afib(x,hr,t,c){const base=c.height/2,baseHr=hr>0?hr:140,rr=1+perlinLikeNoise(x+t*30,.0007,.25),bpm= Math.max(90,Math.min(180, baseHr*rr)),cycle=(60/bpm)*ECG_SPEED,pos=x%cycle,s=pos/cycle;let y=0;
      const qrs=.10*ECG_SPEED/cycle;if(s<qrs){y+=qrsNarrow(s/qrs, .9, .05, .15)} const f=Math.sin((x*.45)+t*8)*(PX_PER_MM*1.4)+Math.sin((x*.95)+t*12)*(PX_PER_MM*.9)+Math.sin((x*1.6)+t*15)*(PX_PER_MM*.6);
      return base+y+f*.9;}
    function vtach(x,hr,t,c){const base=c.height/2,bpm=hr>0?hr:180,amp=1+perlinLikeNoise(x+t*40,.0012,.15),cycle=(60/bpm)*ECG_SPEED,pos=x%cycle,s=pos/cycle;let y=0;
      const qrs=.14*ECG_SPEED/cycle;if(s<qrs){y+=qrsWide(s/qrs,.9*amp)} else {y+=perlinLikeNoise(x,.01,PX_PER_MM*.6)} return base+y;}
    function idioventricular(x,hr,t,c){const base=c.height/2,bpm=hr>0?hr:38,cycle=(60/bpm)*ECG_SPEED,pos=x%cycle,s=pos/cycle;let y=0; const qrs=.16*ECG_SPEED/cycle;
      if(s<qrs){y+=qrsWide(s/qrs,.8)} y+=perlinLikeNoise(x,.006,PX_PER_MM*.5); return base+y;}
    function vfib(x,_hr,t,c){const base=c.height/2,coarse=PX_PER_MV*.9,fine=PX_PER_MV*.25,k=Math.max(0,Math.min(1,t/120)),amp=coarse+(fine-coarse)*k;
      const y=Math.sin(x*.22+t*1.1)*(amp*.6)+Math.sin(x*.33+t*1.5)*(amp*.45)+Math.sin(x*.55+t*.9)*(amp*.35)+Math.sin(x*.88+t*1.7)*(amp*.25)+Math.sin(x*1.4+t*2.2)*(amp*.15)+perlinLikeNoise(x+t*30,.02,amp*.15);
      return base+y;}
    function chb(x,hr,t,c){const base=c.height/2,vBpm=hr>0?hr:32,pBpm=80,vCycle=(60/vBpm)*ECG_SPEED,pCycle=(60/pBpm)*ECG_SPEED,vPos=x%vCycle,pPos=x%pCycle;let y=0;
      const pDur= .08*ECG_SPEED; if(pPos<pDur){y+=pWave(pPos/pDur,.12)} const qrs= .16*ECG_SPEED; if(vPos<qrs){y+=qrsWide(vPos/qrs,.85)} y*=1+perlinLikeNoise(x,.001,.03); return base+y;}
    function paced(x,hr,t,c){const base=c.height/2,bpm=hr>0?hr:70,cycle=(60/bpm)*ECG_SPEED,pos=x%cycle;let y=0; if(pos<3){y+=-PX_PER_MV*2}
      const qrsStart=3,qrsDur=.14*ECG_SPEED; if(pos>=qrsStart && pos<qrsStart+qrsDur){y+=qrsWide((pos-qrsStart)/qrsDur,.9)} else if(pos>=qrsStart+qrsDur && pos<qrsStart+qrsDur+.16*ECG_SPEED){y+=tWave((pos-(qrsStart+qrsDur))/(.16*ECG_SPEED),.25)} return base+y;}
    function brady(x,hr,t,c){return sinusTemplate(x,hr||38,c.height,t,{rAmp:.9,tAmp:.25})}
    function asystole(x,_hr,t,c){const base=c.height/2;const w=Math.sin(t*.2)*(PX_PER_MM*.2);return base+w}
    function drawECGGrid(ctx,w,h){
      ctx.save();
      // fine grid (1 mm)
      ctx.strokeStyle='rgba(255,255,255,0.06)';ctx.lineWidth=1;ctx.beginPath();
      for(let x=0;x<=w;x+=PX_PER_MM){ctx.moveTo(x,0);ctx.lineTo(x,h)} for(let y=0;y<=h;y+=PX_PER_MM){ctx.moveTo(0,y);ctx.lineTo(w,y)} ctx.stroke();
      // big grid (5 mm)
      ctx.strokeStyle='rgba(255,255,255,0.12)';ctx.lineWidth=1.2;ctx.beginPath();
      for(let x=0;x<=w;x+=PX_PER_BIG){ctx.moveTo(x,0);ctx.lineTo(x,h)} for(let y=0;y<=h;y+=PX_PER_BIG){ctx.moveTo(0,y);ctx.lineTo(w,y)} ctx.stroke();
      ctx.restore();
    }
    function drawCalibrationPulse(ctx){const startX=12,startY=Math.floor(ctx.canvas.height*.75),height=PX_PER_MV,width=PX_PER_BIG;ctx.save();ctx.strokeStyle='#0f0';ctx.lineWidth=2;
      ctx.beginPath();ctx.moveTo(startX,startY);ctx.lineTo(startX,startY-height);ctx.lineTo(startX+width,startY-height);ctx.lineTo(startX+width,startY);ctx.stroke();ctx.restore();}
    function withArtefacts(fn){return function(x,hr,t){const cvs=window.__ecgCanvas||document.getElementById('ecgCanvas');let y=fn(x,hr,t,cvs);const st=window.state||{},f=(st.noise||{});
      if(f.movement) y+=movementArtefact(x,t); if(f.leadoff) y+=leadoffArtefact(t); if(f.cpr) y+=cprArtefact(x,t); y+=baselineWander(t); return y;}}
    const rhythms={ nsr:(x,h,t)=>nsr(x,h,t,window.__ecgCanvas), sinus_brady:(x,h,t)=>sinusBrady(x,h,t,window.__ecgCanvas), sinus_tach:(x,h,t)=>sinusTach(x,h,t,window.__ecgCanvas),
      svt:(x,h,t)=>svt(x,h,t,window.__ecgCanvas), afib:(x,h,t)=>afib(x,h,t,window.__ecgCanvas), vtach:(x,h,t)=>vtach(x,h,t,window.__ecgCanvas), vfib:(x,h,t)=>vfib(x,h,t,window.__ecgCanvas),
      brady:(x,h,t)=>brady(x,h,t,window.__ecgCanvas), chb:(x,h,t)=>chb(x,h,t,window.__ecgCanvas), paced:(x,h,t)=>paced(x,h,t,window.__ecgCanvas), idioventricular:(x,h,t)=>idioventricular(x,h,t,window.__ecgCanvas),
      asystole:(x,h,t)=>asystole(x,h,t,window.__ecgCanvas), sinus:(x,h,t)=>nsr(x,h,t,window.__ecgCanvas) };
    const wrapped={}; Object.keys(rhythms).forEach(k=>wrapped[k]=withArtefacts(rhythms[k]));
    window.rhythms=wrapped; window.drawECGGrid=drawECGGrid; window.drawCalibrationPulse=drawCalibrationPulse; window.__setECGSpeed=setSpeed;
  })();
  </script>

  <!-- App logic -->
  <script>
    const scenarios = {
      'vf-arrest': { name:'Ventricular Fibrillation', description:'Cardiac arrest. Coarse VF. Immediate defibrillation required.', initialRhythm:'vfib',
        initialVitals:{hr:0,spo2:0,etco2:0,bpSys:0,bpDia:0}, hasPulse:false, shockable:true, requiresSync:false, recommendedEnergy:150, successEnergy:150, shockToConvert:3,
        successRhythm:'nsr', successVitals:{hr:82,spo2:94,etco2:35,bpSys:110,bpDia:70} },
      'pulseless-vt': { name:'Pulseless Ventricular Tachycardia', description:'Cardiac arrest. Broad complex tachycardia. Confirm no pulse. Defibrillate.', initialRhythm:'vtach',
        initialVitals:{hr:0,spo2:0,etco2:0,bpSys:0,bpDia:0}, hasPulse:false, shockable:true, requiresSync:false, recommendedEnergy:150, successEnergy:150, shockToConvert:2,
        successRhythm:'nsr', successVitals:{hr:78,spo2:93,etco2:34,bpSys:108,bpDia:68} },
      'unstable-vt': { name:'VT with Pulse - Unstable', description:'Broad complex tachycardia with pulse. Low BP. Requires SYNCHRONISED cardioversion.', initialRhythm:'vtach',
        initialVitals:{hr:180,spo2:88,etco2:28,bpSys:82,bpDia:48}, hasPulse:true, shockable:true, requiresSync:true, recommendedEnergy:120, successEnergy:120, shockToConvert:1,
        successRhythm:'nsr', successVitals:{hr:76,spo2:97,etco2:36,bpSys:118,bpDia:74} },
      'unstable-svt': { name:'SVT with Adverse Features', description:'Narrow complex tachycardia causing compromise. Requires SYNCHRONISED cardioversion.', initialRhythm:'svt',
        initialVitals:{hr:190,spo2:90,etco2:26,bpSys:80,bpDia:54}, hasPulse:true, shockable:true, requiresSync:true, recommendedEnergy:100, successEnergy:100, shockToConvert:1,
        successRhythm:'nsr', successVitals:{hr:74,spo2:98,etco2:36,bpSys:120,bpDia:76} },
      'fast-af': { name:'Fast AF with Adverse Features', description:'Rapid atrial fibrillation with shock/heart failure. Requires SYNCHRONISED cardioversion.', initialRhythm:'afib',
        initialVitals:{hr:155,spo2:88,etco2:30,bpSys:82,bpDia:48}, hasPulse:true, shockable:true, requiresSync:true, recommendedEnergy:120, successEnergy:120, shockToConvert:1,
        successRhythm:'nsr', successVitals:{hr:80,spo2:96,etco2:35,bpSys:118,bpDia:72} },
      'complete-hb': { name:'Complete Heart Block', description:'Syncope and hypotension. Complete AV dissociation. Requires pacing.', initialRhythm:'chb',
        initialVitals:{hr:32,spo2:92,etco2:30,bpSys:86,bpDia:50}, hasPulse:true, shockable:false, requiresPacing:true, captureThreshold:70, successRate:70,
        successVitals:{hr:70,spo2:97,etco2:36,bpSys:115,bpDia:72} },
      'symptomatic-brady': { name:'Symptomatic Bradycardia', description:'Severely symptomatic bradycardia unresponsive to atropine. Requires pacing.', initialRhythm:'brady',
        initialVitals:{hr:38,spo2:93,etco2:31,bpSys:84,bpDia:52}, hasPulse:true, shockable:false, requiresPacing:true, captureThreshold:65, successRate:70,
        successVitals:{hr:70,spo2:97,etco2:35,bpSys:112,bpDia:70} }
    };

    const state = {
      selectedMode:null, selectedScenario:null, scenarioActive:false, scenarioStartTime:null,
      deviceMode:'monitor', rhythm:'nsr',
      hr:75, spo2:98, etco2:38, bpSys:120, bpDia:80,
      energy:120, energyLevels:[50,70,85,100,120,150,170,200],
      charged:false, syncMode:false, shockCount:0,
      pacerOutput:0, pacerRate:60, pacingActive:false,
      actions:[], hasPulse:true, roscAchieved:false,
      noise:{movement:false, cpr:false, leadoff:false}
    };

    let canvas, ctx, animationId, lastTimestamp=0, waveformX=0, tStart=0;

    function initCanvas(){
      canvas = document.getElementById('ecgCanvas');
      window.__ecgCanvas = canvas;
      const rect = canvas.getBoundingClientRect();
      const dpr = window.devicePixelRatio || 1;
      canvas.style.width = rect.width + 'px';
      canvas.style.height = rect.height + 'px';
      canvas.width = Math.floor(rect.width * dpr);
      canvas.height = Math.floor(rect.height * dpr);
      ctx = canvas.getContext('2d');
      ctx.setTransform(dpr,0,0,dpr,0,0);
      ctx.imageSmoothingEnabled = false;
      ctx.lineJoin='round'; ctx.lineCap='round';
      if(animationId) cancelAnimationFrame(animationId);
      lastTimestamp = 0; waveformX = 0; tStart = performance.now();
      animationId = requestAnimationFrame(animate);
    }

    function drawSyncTicks(rrPx){
      if(!state.syncMode || rrPx < 20) return;
      const w = canvas.width / (window.devicePixelRatio||1);
      const phase = (w - ((waveformX) % rrPx));
      const start = phase % rrPx;
      const dpr = window.devicePixelRatio || 1;
      ctx.save();
      ctx.fillStyle = '#fff';
      for(let x = start; x < w; x += rrPx){
        ctx.fillRect(Math.round(x), 2, 2, 10);
      }
      ctx.restore();
    }

    function animate(ts){
      if(!lastTimestamp) lastTimestamp = ts;
      const dt = (ts - lastTimestamp) / 1000;
      lastTimestamp = ts;
      const tSeconds = (ts - tStart) / 1000;

      const w = canvas.width / (window.devicePixelRatio||1);
      const h = canvas.height / (window.devicePixelRatio||1);
      ctx.fillStyle = '#000'; ctx.fillRect(0,0,w,h);
      drawECGGrid(ctx, w, h);
      drawCalibrationPulse(ctx);

      ctx.beginPath();
      ctx.lineWidth = 2;
      ctx.strokeStyle = '#0f0';
      let yPrev = rhythms[state.rhythm](0, state.hr, tSeconds);
      ctx.moveTo(0, yPrev);
      for(let x = 1; x < w; x++){
        const y = rhythms[state.rhythm](x + waveformX, state.hr, tSeconds);
        ctx.lineTo(x, y);
      }
      ctx.stroke();

      if(state.hr > 0){
        const rrPx = (60 / state.hr) * 125;
        drawSyncTicks(rrPx);
      }

      waveformX += 125 * dt;
      document.getElementById('timeInfo').textContent = new Date().toLocaleTimeString();
      animationId = requestAnimationFrame(animate);
    }

    function setMode(mode){
      state.deviceMode = mode;
      document.querySelectorAll('.mode-label').forEach(x => x.classList.remove('active'));
      document.querySelector(\`.mode-label[data-mode="\${mode}"]\`)?.classList.add('active');
      document.getElementById('modeInfo').textContent = 'MODE: ' + mode.toUpperCase();
      document.getElementById('instructorSubtitle').textContent = mode.charAt(0).toUpperCase()+mode.slice(1) + ' mode';
      document.getElementById('pacingStatus').textContent = state.pacingActive ? 'ON' : 'OFF';
    }

    function toggleSync(){
      state.syncMode = !state.syncMode;
      document.getElementById('syncBtn').classList.toggle('active', state.syncMode);
      document.getElementById('syncStatus').textContent = state.syncMode ? 'ON' : 'OFF';
      document.getElementById('syncIndicator').textContent = state.syncMode ? 'SYNC' : '';
      document.getElementById('syncIndicator').className = state.syncMode ? 'screen-info sync' : 'screen-info';
    }

    function quickSetRhythm(r){
      state.rhythm = r;
      document.querySelectorAll('.rhythm-btn').forEach(b => b.classList.remove('active'));
      document.querySelectorAll(\`.rhythm-btn[data-rhythm="\${r}"]\`).forEach(b => b.classList.add('active'));
      updateVitalsForRhythm();
    }

    function updateVitalsForRhythm(){
      const vmap = {
        nsr:{hr:75,spo2:98,etco2:38,bp:'120/80',pulse:true},
        sinus_brady:{hr:45,spo2:96,etco2:35,bp:'90/50',pulse:true},
        sinus_tach:{hr:120,spo2:97,etco2:36,bp:'110/70',pulse:true},
        svt:{hr:190,spo2:90,etco2:26,bp:'80/54',pulse:true},
        afib:{hr:155,spo2:88,etco2:30,bp:'82/48',pulse:true},
        vtach:{hr:180,spo2:88,etco2:28,bp:'82/48',pulse:true},
        vfib:{hr:0,spo2:0,etco2:0,bp:'0/0',pulse:false},
        asystole:{hr:0,spo2:0,etco2:0,bp:'0/0',pulse:false},
        chb:{hr:32,spo2:92,etco2:30,bp:'86/50',pulse:true},
        paced:{hr:70,spo2:97,etco2:36,bp:'115/72',pulse:true},
        idioventricular:{hr:40,spo2:93,etco2:32,bp:'90/55',pulse:true}
      };
      const v = vmap[state.rhythm] || vmap.nsr;
      state.hr = v.hr; state.hasPulse = v.pulse;
      document.getElementById('hrDisplay').textContent = v.hr;
      document.getElementById('spo2Display').textContent = v.spo2;
      document.getElementById('etco2Display').textContent = v.etco2;
      document.getElementById('bpDisplay').textContent = v.bp;
    }

    function toggleArtefact(kind, on){
      state.noise[kind] = on;
      if(kind==='cpr'){
        document.getElementById('messageBar').textContent = on ? 'CPR IN PROGRESS ‚Äì ECG DEGRADED' : 'SIMULATOR READY';
      }
    }

    function adjustEnergy(dir){
      const arr = state.energyLevels;
      let i = arr.indexOf(state.energy);
      if(i<0) i = arr.indexOf(120);
      i = Math.max(0, Math.min(arr.length-1, i + dir));
      state.energy = arr[i];
      document.getElementById('energyDisplay').textContent = state.energy;
    }

    function chargeDefib(){
      state.charged = true;
      document.getElementById('messageBar').textContent = 'CHARGED ‚Äì STAND CLEAR';
      document.getElementById('shockBtn').disabled = false;
      state.actions.push(\`Charged to \${state.energy} J\`);
    }

    function deliverShock(){
      if(!state.charged) return;
      state.shockCount += 1;
      document.getElementById('shockCounter').textContent = state.shockCount;
      state.charged = false;
      document.getElementById('shockBtn').disabled = true;
      state.actions.push(\`Shock \${state.shockCount} at \${state.energy} J\${state.syncMode ? ' (SYNC)' : ''}\`);

      if(state.selectedScenario){
        const sc = scenarios[state.selectedScenario];
        if(sc.shockable){
          if((!sc.requiresSync || state.syncMode) && state.energy >= sc.successEnergy && state.shockCount >= sc.shockToConvert){
            state.rhythm = sc.successRhythm;
            updateVitals(sc.successVitals);
            state.roscAchieved = !sc.hasPulse;
            document.getElementById('messageBar').textContent = 'CONVERSION ACHIEVED';
          } else {
            document.getElementById('messageBar').textContent = 'NO CONVERSION';
          }
        } else {
          document.getElementById('messageBar').textContent = 'NO SHOCK ADVISED';
        }
      } else {
        document.getElementById('messageBar').textContent = 'SHOCK DELIVERED';
      }
    }

    function analyseRhythm(){
      const shockable = ['vfib','vtach'].includes(state.rhythm) && !state.hasPulse;
      document.getElementById('messageBar').textContent = shockable ? 'SHOCK ADVISED' : 'NO SHOCK ADVISED';
      state.actions.push('Analyse -> ' + (shockable ? 'Shock advised' : 'No shock'));
    }

    function adjustPacer(which, delta){
      if(which==='output'){ state.pacerOutput = Math.max(0, Math.min(200, state.pacerOutput + delta)); }
      else { state.pacerRate = Math.max(30, Math.min(120, state.pacerRate + delta)); }
      document.getElementById('outputDisplay').textContent = state.pacerOutput;
      document.getElementById('outputDisplay2').textContent = state.pacerOutput;
      document.getElementById('rateDisplay').textContent = state.pacerRate;
      document.getElementById('rateDisplay2').textContent = state.pacerRate;

      if(state.selectedScenario){
        const sc = scenarios[state.selectedScenario];
        if(sc.requiresPacing && state.pacerOutput >= sc.captureThreshold){
          state.pacingActive = true;
          document.getElementById('pacingStatus').textContent = 'ON';
          if(state.rhythm!=='paced'){
            state.rhythm = 'paced';
            updateVitals(sc.successVitals);
            document.getElementById('messageBar').textContent = 'ELECTRICAL CAPTURE ACHIEVED';
          }
        }
      }
    }

    function updateVitals(v){
      state.hr=v.hr; state.spo2=v.spo2; state.etco2=v.etco2; state.bpSys=v.bpSys; state.bpDia=v.bpDia;
      document.getElementById('hrDisplay').textContent = v.hr;
      document.getElementById('spo2Display').textContent = v.spo2;
      document.getElementById('etco2Display').textContent = v.etco2;
      document.getElementById('bpDisplay').textContent = v.bpSys + '/' + v.bpDia;
    }

    function selectMode(mode){
      state.selectedMode = mode;
      document.getElementById('modeTitle').textContent = mode === 'education' ? 'Education Mode' : 'Testing Mode';
      document.getElementById('modeSelectScreen').style.display='none';
      document.getElementById('scenarioScreen').style.display='flex';
      document.getElementById('instructorPanel').style.display = (mode === 'education') ? 'block' : 'none';
      document.getElementById('quickRhythmPanel').style.display = 'block';
    }

    function backToModeSelect(){
      document.getElementById('scenarioScreen').style.display='none';
      document.getElementById('modeSelectScreen').style.display='flex';
    }

    function selectScenario(key){
      const sc = scenarios[key];
      state.selectedScenario = key;
      state.scenarioActive = true;
      state.scenarioStartTime = Date.now();
      state.actions = [];
      state.shockCount = 0;
      document.getElementById('shockCounter').textContent = '0';

      state.rhythm = sc.initialRhythm;
      updateVitals(sc.initialVitals);
      state.hasPulse = sc.hasPulse;

      document.getElementById('scenarioScreen').style.display='none';
      document.getElementById('btnEndScenario').style.display = 'inline-flex';
      document.getElementById('btnResetScenario').style.display = 'inline-flex';
      if(state.selectedMode === 'education') document.getElementById('instructorPanel').style.display='block';

      document.getElementById('messageBar').textContent = 'SCENARIO STARTED';
    }

    function endScenario(){
      const sc = scenarios[state.selectedScenario] || {};
      document.getElementById('summaryScenarioName').textContent = sc.name || '(Custom)';
      document.getElementById('summaryScenarioDesc').textContent = sc.description || '';
      document.getElementById('summaryActions').innerHTML = state.actions.map(a=>`‚Ä¢ ${a}`).join('<br>');
      const feedback = [];
      if(sc.requiresSync && !state.actions.some(a=>a.includes('(SYNC)'))) feedback.push('SYNCH not used for a scenario that required it.');
      if(sc.shockable && state.shockCount===0) feedback.push('No defibrillation delivered.');
      if(sc.requiresPacing && !state.pacingActive) feedback.push('Pacing not achieved.');
      if(feedback.length===0) feedback.push('Good device handling.');
      document.getElementById('summaryFeedback').innerHTML = feedback.map(f=>'‚Ä¢ '+f).join('<br>');
      const outcome = (state.rhythm==='nsr' || state.rhythm==='paced') ? 'Haemodynamics improved.' : 'No conversion.';
      document.getElementById('summaryOutcome').textContent = outcome;

      document.getElementById('summaryScreen').style.display='flex';
      document.getElementById('btnEndScenario').style.display='none';
      document.getElementById('btnResetScenario').style.display='none';
      document.getElementById('instructorPanel').style.display='none';
    }

    function resetScenario(){
      if(!state.selectedScenario) return;
      selectScenario(state.selectedScenario);
    }

    function tryAgain(){
      document.getElementById('summaryScreen').style.display='none';
      selectScenario(state.selectedScenario);
    }

    function returnToMenu(){
      document.getElementById('summaryScreen').style.display='none';
      document.getElementById('modeSelectScreen').style.display='flex';
    }

    function printCertificate(){
      const sc = scenarios[state.selectedScenario] || {};
      document.getElementById('certScenarioName').textContent = sc.name || '(Custom scenario)';
      document.getElementById('certPerformance').innerHTML = state.actions.map(a=>'‚Ä¢ '+a).join('<br>');
      document.getElementById('certDate').textContent = new Date().toLocaleDateString();
      document.getElementById('certificateScreen').style.display='flex';
    }

    function backToSummary(){
      document.getElementById('certificateScreen').style.display='none';
      document.getElementById('summaryScreen').style.display='flex';
    }

    function checkPulse(){
      const text = state.hasPulse ? 'PULSE PRESENT' : 'NO PULSE';
      document.getElementById('messageBar').textContent = text;
      state.actions.push('Pulse check -> ' + text);
    }

    window.addEventListener('resize', initCanvas);
    window.addEventListener('load', () => {
      initCanvas();
      updateVitalsForRhythm();
      document.getElementById('modeSelectScreen').style.display='flex';
      document.getElementById('quickRhythmPanel').style.display = 'block';
    });
  </script>
</body>
</html>
